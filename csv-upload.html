<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FinanceOS - Upload CSV</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#8b5cf6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Include Papa Parse for CSV processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        /* CSS Variables for Premium Design System */
        :root {
            --primary-bg: linear-gradient(135deg, #0f172a 0%, #1e1b4b 25%, #312e81 50%, #1e1b4b 75%, #0f172a 100%);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-premium: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(59, 130, 246, 0.15) 50%, rgba(147, 51, 234, 0.15) 100%);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-premium-border: rgba(255, 255, 255, 0.2);
            --text-primary: rgba(255, 255, 255, 0.9);
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-muted: rgba(255, 255, 255, 0.5);
            --gradient-purple: linear-gradient(135deg, #8b5cf6 0%, #a855f7 50%, #9333ea 100%);
            --gradient-blue: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #1d4ed8 100%);
            --gradient-green: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
            --gradient-red: linear-gradient(135deg, #ef4444 0%, #dc2626 50%, #b91c1c 100%);
            --gradient-orange: linear-gradient(135deg, #f97316 0%, #ea580c 50%, #c2410c 100%);
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Glass Effects */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .glass-premium {
            background: var(--glass-premium);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-premium-border);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        /* Header */
        .header {
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 12px 20px;
            border-radius: 0;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 700;
            color: white;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: var(--gradient-purple);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .nav {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-button {
            padding: 8px 20px;
            border-radius: 12px;
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 16px;
            transition: all 0.3s ease;
            border: none;
            background: transparent;
            cursor: pointer;
            position: relative;
        }

        .nav-button:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-button.active {
            color: white;
            background: rgba(139, 92, 246, 0.3);
        }

        .nav-button.active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: #8b5cf6;
            border-radius: 50%;
        }

        .privacy-toggle {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .logout-button {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Main Content */
        .main-content {
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .page-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #8b5cf6, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
        }

        /* Upload Area */
        .upload-container {
            margin-bottom: 32px;
        }

        .upload-zone {
            border: 2px dashed var(--glass-border);
            border-radius: 20px;
            padding: 60px 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-zone.dragover {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
            transform: scale(1.02);
        }

        .upload-zone:hover {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.05);
        }

        .upload-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.8;
        }

        .upload-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: white;
        }

        .upload-subtitle {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 20px;
        }

        .upload-button {
            background: var(--gradient-purple);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(139, 92, 246, 0.4);
        }

        /* File List */
        .file-list {
            margin-top: 24px;
        }

        .file-item {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-green);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .file-details h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .file-details p {
            font-size: 12px;
            color: var(--text-muted);
        }

        .file-actions {
            display: flex;
            gap: 8px;
        }

        .file-action {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-action.remove {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .file-action.process {
            background: var(--gradient-blue);
            color: white;
        }

        /* Progress Bar */
        .progress-container {
            margin-top: 16px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-green);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Bank Format Guide */
        .bank-guide {
            margin-bottom: 32px;
        }

        .bank-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .bank-card {
            padding: 20px;
            border-radius: 16px;
            text-align: center;
        }

        .bank-logo {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 12px;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #1e1b4b;
        }

        .bank-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .bank-format {
            font-size: 12px;
            color: var(--text-muted);
            font-family: monospace;
            line-height: 1.4;
        }

        /* Processing Results */
        .results-container {
            margin-top: 32px;
            display: none;
        }

        .result-card {
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 16px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .result-title {
            font-size: 18px;
            font-weight: 600;
        }

        .result-status {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .status-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .status-error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* Transaction Preview */
        .transaction-preview {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
        }

        .transaction-item {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-details {
            flex: 1;
        }

        .transaction-description {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .transaction-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        .transaction-amount {
            font-size: 16px;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .amount-positive {
            color: var(--success);
        }

        .amount-negative {
            color: var(--error);
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .summary-card {
            padding: 20px;
            border-radius: 16px;
            text-align: center;
        }

        .summary-card h3 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .summary-card .value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .summary-card .change {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Actions */
        .upload-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 24px;
        }

        .action-button {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-button.primary {
            background: var(--gradient-purple);
            color: white;
        }

        .action-button.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
        }

        .action-button:hover {
            transform: translateY(-2px);
        }

        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 12px;
            }

            .nav {
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
            }

            .nav-button {
                font-size: 14px;
                padding: 6px 12px;
            }

            .upload-zone {
                padding: 40px 20px;
            }

            .upload-icon {
                font-size: 48px;
            }

            .upload-text {
                font-size: 16px;
            }

            .bank-cards {
                grid-template-columns: 1fr;
            }

            .file-item {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .file-actions {
                justify-content: center;
            }
        }

        .hidden {
            display: none;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #8b5cf6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Success Animation */
        .success-animation {
            animation: successPulse 0.6s ease-out;
        }

        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <header class="header glass">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">
                    <span style="font-size: 24px; color: white;">$</span>
                </div>
                <span class="logo-text">FinanceOS</span>
            </div>
            
            <nav class="nav">
                <a href="index.html" class="nav-button">Dashboard</a>
                <a href="csv-upload.html" class="nav-button active">Upload CSV</a>
                <a href="goals.html" class="nav-button">Goals</a>
                <a href="budget.html" class="nav-button">Budget</a>
                <button class="privacy-toggle nav-button" id="privacyToggle">🔒 Privacy</button>
                <button class="logout-button nav-button" onclick="logout()">🚪 Logout</button>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="page-header">
            <h1 class="page-title">Upload Bank Statements</h1>
            <p class="page-subtitle">Import your CSV files to automatically categorize transactions and update your budget</p>
        </div>

        <!-- Bank Format Guide -->
        <section class="bank-guide">
            <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: white;">Supported New Zealand Banks</h2>
            <div class="bank-cards">
                <div class="bank-card glass">
                    <div class="bank-logo">ANZ</div>
                    <div class="bank-name">ANZ Bank</div>
                    <div class="bank-format">Date, Amount, Description, Balance</div>
                </div>
                
                <div class="bank-card glass">
                    <div class="bank-logo">ASB</div>
                    <div class="bank-name">ASB Bank</div>
                    <div class="bank-format">Date, Unique Id, Tran Type, Payee, Memo, Amount</div>
                </div>
                
                <div class="bank-card glass">
                    <div class="bank-logo">BNZ</div>
                    <div class="bank-name">Bank of New Zealand</div>
                    <div class="bank-format">Date, Amount, Payee, Description, Reference</div>
                </div>
                
                <div class="bank-card glass">
                    <div class="bank-logo">KIWI</div>
                    <div class="bank-name">Kiwibank</div>
                    <div class="bank-format">Date, Memo/Description, Amount, Balance</div>
                </div>
                
                <div class="bank-card glass">
                    <div class="bank-logo">WBC</div>
                    <div class="bank-name">Westpac</div>
                    <div class="bank-format">Date, Amount, Other Party, Description, Balance</div>
                </div>
                
                <div class="bank-card glass">
                    <div class="bank-logo">TSB</div>
                    <div class="bank-name">TSB Bank</div>
                    <div class="bank-format">Date, Description, Amount, Balance</div>
                </div>
            </div>
        </section>

        <!-- Upload Area -->
        <section class="upload-container">
            <div class="upload-zone glass-premium" id="uploadZone">
                <div class="upload-icon">📤</div>
                <div class="upload-text">Drop your CSV files here</div>
                <div class="upload-subtitle">or click to browse files (multiple files supported)</div>
                <button class="upload-button" onclick="document.getElementById('fileInput').click()">
                    Choose Files
                </button>
                <input type="file" id="fileInput" multiple accept=".csv,.xlsx,.xls,.qif,.ofx" style="display: none;">
            </div>

            <!-- Progress Bar -->
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Processing files...</div>
            </div>

            <!-- File List -->
            <div class="file-list" id="fileList"></div>

            <!-- Upload Actions -->
            <div class="upload-actions" id="uploadActions" style="display: none;">
                <button class="action-button primary" id="processAllBtn" onclick="processAllFiles()">
                    Process All Files
                </button>
                <button class="action-button secondary" id="clearAllBtn" onclick="clearAllFiles()">
                    Clear All
                </button>
            </div>
        </section>

        <!-- Processing Results -->
        <section class="results-container" id="resultsContainer">
            <!-- Summary Cards -->
            <div class="summary-cards" id="summaryCards" style="display: none;">
                <div class="summary-card glass-premium">
                    <h3>Total Transactions</h3>
                    <div class="value" id="totalTransactions">0</div>
                    <div class="change">Imported successfully</div>
                </div>
                
                <div class="summary-card glass-premium">
                    <h3>Total Income</h3>
                    <div class="value positive" id="totalIncome">$0.00</div>
                    <div class="change">From all files</div>
                </div>
                
                <div class="summary-card glass-premium">
                    <h3>Total Expenses</h3>
                    <div class="value negative" id="totalExpenses">$0.00</div>
                    <div class="change">From all files</div>
                </div>
                
                <div class="summary-card glass-premium">
                    <h3>Net Change</h3>
                    <div class="value" id="netChange">$0.00</div>
                    <div class="change">Income - Expenses</div>
                </div>
            </div>

            <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: white; display: none;" id="resultsTitle">Processing Results</h2>
            <div id="resultsContent"></div>
        </section>
    </main>

    <script>
        // Application State
        let uploadedFiles = [];
        let processedTransactions = [];
        let totalStats = {
            transactions: 0,
            income: 0,
            expenses: 0,
            netChange: 0
        };

        // Bank format configurations for NZ banks
        const BANK_FORMATS = {
            ANZ: {
                headers: ['Date', 'Amount', 'Description', 'Balance'],
                dateIndex: 0,
                amountIndex: 1,
                descriptionIndex: 2,
                balanceIndex: 3
            },
            ASB: {
                headers: ['Date', 'Unique Id', 'Tran Type', 'Cheque Number', 'Payee', 'Memo', 'Amount'],
                dateIndex: 0,
                amountIndex: 6,
                descriptionIndex: 5,
                payeeIndex: 4
            },
            BNZ: {
                headers: ['Date', 'Amount', 'Payee', 'Description', 'Reference', 'Transaction Type'],
                dateIndex: 0,
                amountIndex: 1,
                descriptionIndex: 3,
                payeeIndex: 2
            },
            KIWIBANK: {
                headers: ['Date', 'Memo/Description', 'Amount', 'Balance'],
                dateIndex: 0,
                amountIndex: 2,
                descriptionIndex: 1,
                balanceIndex: 3
            },
            WESTPAC: {
                headers: ['Date', 'Amount', 'Other Party', 'Description', 'Reference', 'Particulars', 'Code', 'Reference', 'Balance'],
                dateIndex: 0,
                amountIndex: 1,
                descriptionIndex: 3,
                payeeIndex: 2,
                balanceIndex: 8
            },
            TSB: {
                headers: ['Date', 'Description', 'Amount', 'Balance'],
                dateIndex: 0,
                amountIndex: 2,
                descriptionIndex: 1,
                balanceIndex: 3
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupUploadHandlers();
            checkAuthState();
            loadExistingData();
        });

        function checkAuthState() {
            const authToken = localStorage.getItem('financeos_auth');
            if (!authToken) {
                window.location.href = 'index.html';
                return;
            }
        }

        function logout() {
            localStorage.removeItem('financeos_auth');
            window.location.href = 'index.html';
        }

        function setupUploadHandlers() {
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');

            // Drag and drop handlers
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                if (!uploadZone.contains(e.relatedTarget)) {
                    uploadZone.classList.remove('dragover');
                }
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleFiles(files);
            });

            // Click handler
            uploadZone.addEventListener('click', () => {
                fileInput.click();
            });

            // File input change handler
            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                handleFiles(files);
            });

            // Privacy toggle
            const privacyToggle = document.getElementById('privacyToggle');
            if (privacyToggle) {
                privacyToggle.addEventListener('click', togglePrivacyMode);
            }
        }

        function handleFiles(files) {
            console.log('Files selected:', files.length);
            
            const validFiles = files.filter(file => {
                const extension = file.name.toLowerCase().split('.').pop();
                return ['csv', 'xlsx', 'xls', 'qif', 'ofx'].includes(extension);
            });

            if (validFiles.length === 0) {
                alert('Please select valid CSV, Excel, QIF, or OFX files.');
                return;
            }

            // Add files to upload queue
            validFiles.forEach(file => {
                const fileId = Date.now() + Math.random();
                uploadedFiles.push({
                    id: fileId,
                    file: file,
                    name: file.name,
                    size: file.size,
                    status: 'pending',
                    bankFormat: null,
                    transactions: [],
                    errors: []
                });
            });

            renderFileList();
            showUploadActions();
            
            // Auto-process if less than 3 files
            if (validFiles.length <= 2) {
                setTimeout(() => processAllFiles(), 500);
            }
        }

        function renderFileList() {
            const fileList = document.getElementById('fileList');
            
            if (uploadedFiles.length === 0) {
                fileList.innerHTML = '';
                return;
            }

            const html = uploadedFiles.map(fileObj => `
                <div class="file-item" id="file-${fileObj.id}">
                    <div class="file-info">
                        <div class="file-icon">📄</div>
                        <div class="file-details">
                            <h4>${fileObj.name}</h4>
                            <p>${formatFileSize(fileObj.size)} • ${fileObj.status}</p>
                        </div>
                    </div>
                    <div class="file-actions">
                        ${fileObj.status === 'pending' ? `
                            <button class="file-action process" onclick="processSingleFile('${fileObj.id}')">Process</button>
                            <button class="file-action remove" onclick="removeFile('${fileObj.id}')">Remove</button>
                        ` : fileObj.status === 'processing' ? `
                            <div class="spinner"></div>
                            <span style="color: var(--info);">Processing...</span>
                        ` : fileObj.status === 'success' ? `
                            <span style="color: var(--success);">✅ ${fileObj.transactions.length} transactions</span>
                            <button class="file-action remove" onclick="removeFile('${fileObj.id}')">Remove</button>
                        ` : `
                            <span style="color: var(--error);">❌ Error</span>
                            <button class="file-action remove" onclick="removeFile('${fileObj.id}')">Remove</button>
                        `}
                    </div>
                </div>
            `).join('');

            fileList.innerHTML = html;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showUploadActions() {
            const actions = document.getElementById('uploadActions');
            actions.style.display = uploadedFiles.length > 0 ? 'flex' : 'none';
        }

        async function processAllFiles() {
            const processBtn = document.getElementById('processAllBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            processBtn.disabled = true;
            processBtn.innerHTML = '<div class="spinner"></div>Processing...';
            progressContainer.style.display = 'block';

            let processed = 0;
            const total = uploadedFiles.filter(f => f.status === 'pending').length;

            for (const fileObj of uploadedFiles) {
                if (fileObj.status === 'pending') {
                    await processSingleFile(fileObj.id, false);
                    processed++;
                    
                    const progress = (processed / total) * 100;
                    progressFill.style.width = progress + '%';
                    progressText.textContent = `Processing ${processed}/${total} files...`;
                }
            }

            // Complete processing
            progressText.textContent = 'Processing complete!';
            setTimeout(() => {
                progressContainer.style.display = 'none';
                processBtn.disabled = false;
                processBtn.innerHTML = 'Process All Files';
            }, 1000);

            // Update all figures
            updateFinancialFigures();
            showProcessingResults();
        }

        async function processSingleFile(fileId, updateFigures = true) {
            const fileObj = uploadedFiles.find(f => f.id == fileId);
            if (!fileObj || fileObj.status !== 'pending') return;

            fileObj.status = 'processing';
            renderFileList();

            try {
                const transactions = await parseCSVFile(fileObj.file);
                
                if (transactions.length === 0) {
                    throw new Error('No transactions found in file');
                }

                // Detect bank format
                fileObj.bankFormat = detectBankFormat(transactions[0]);
                
                // Process and clean transactions
                fileObj.transactions = transactions.map(row => processTransaction(row, fileObj.bankFormat));
                fileObj.status = 'success';

                console.log(`Processed ${fileObj.transactions.length} transactions from ${fileObj.name}`);

                // Add to global processed transactions
                processedTransactions.push(...fileObj.transactions);

                // Save to localStorage
                saveTransactionsToStorage();

                if (updateFigures) {
                    updateFinancialFigures();
                    showProcessingResults();
                }

            } catch (error) {
                console.error('Error processing file:', error);
                fileObj.status = 'error';
                fileObj.errors.push(error.message);
            }

            renderFileList();
        }

        function parseCSVFile(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    delimitersToGuess: [',', '\t', '|', ';'],
                    complete: function(results) {
                        if (results.errors.length > 0) {
                            console.warn('CSV parsing warnings:', results.errors);
                        }
                        resolve(results.data);
                    },
                    error: function(error) {
                        reject(error);
                    }
                });
            });
        }

        function detectBankFormat(sampleRow) {
            const headers = Object.keys(sampleRow);
            
            // Try to match against known bank formats
            for (const [bankName, format] of Object.entries(BANK_FORMATS)) {
                const matchScore = calculateHeaderMatch(headers, format.headers);
                if (matchScore > 0.7) {
                    console.log(`Detected bank format: ${bankName} (${matchScore.toFixed(2)} match)`);
                    return bankName;
                }
            }

            // Generic format detection
            const dateFields = headers.filter(h => /date/i.test(h));
            const amountFields = headers.filter(h => /amount|value|debit|credit/i.test(h));
            const descFields = headers.filter(h => /desc|memo|detail|payee|merchant/i.test(h));

            if (dateFields.length > 0 && amountFields.length > 0 && descFields.length > 0) {
                console.log('Using generic format detection');
                return 'GENERIC';
            }

            throw new Error('Unable to detect bank format. Please check your CSV headers.');
        }

        function calculateHeaderMatch(fileHeaders, bankHeaders) {
            let matches = 0;
            for (const bankHeader of bankHeaders) {
                if (fileHeaders.some(fh => fh.toLowerCase().includes(bankHeader.toLowerCase()) || 
                                           bankHeader.toLowerCase().includes(fh.toLowerCase()))) {
                    matches++;
                }
            }
            return matches / bankHeaders.length;
        }

        function processTransaction(row, bankFormat) {
            const format = BANK_FORMATS[bankFormat];
            let transaction = {
                id: Date.now() + Math.random(),
                date: '',
                amount: 0,
                description: '',
                category: 'Other',
                account: 'Unknown',
                balance: null,
                payee: '',
                originalRow: row
            };

            try {
                // Handle generic format
                if (bankFormat === 'GENERIC') {
                    transaction = processGenericTransaction(row);
                } else if (format) {
                    // Use specific bank format
                    const headers = Object.keys(row);
                    
                    // Extract date
                    const dateValue = row[headers[format.dateIndex]] || 
                                    findValueByPattern(row, /date/i);
                    transaction.date = parseDate(dateValue);

                    // Extract amount
                    const amountValue = row[headers[format.amountIndex]] || 
                                      findValueByPattern(row, /amount|value/i);
                    transaction.amount = parseAmount(amountValue);

                    // Extract description
                    const descValue = row[headers[format.descriptionIndex]] || 
                                    findValueByPattern(row, /desc|memo|detail/i);
                    transaction.description = String(descValue || '').trim();

                    // Extract payee if available
                    if (format.payeeIndex !== undefined) {
                        const payeeValue = row[headers[format.payeeIndex]];
                        transaction.payee = String(payeeValue || '').trim();
                    }

                    // Extract balance if available
                    if (format.balanceIndex !== undefined) {
                        const balanceValue = row[headers[format.balanceIndex]];
                        transaction.balance = parseAmount(balanceValue);
                    }
                }

                // Auto-categorize transaction
                transaction.category = categorizeTransaction(transaction.description, transaction.payee);

                // Validate required fields
                if (!transaction.date) {
                    throw new Error('Missing or invalid date');
                }
                if (isNaN(transaction.amount)) {
                    throw new Error('Missing or invalid amount');
                }

            } catch (error) {
                console.warn('Error processing transaction:', error, row);
                transaction.error = error.message;
            }

            return transaction;
        }

        function processGenericTransaction(row) {
            const headers = Object.keys(row);
            let transaction = {
                id: Date.now() + Math.random(),
                date: '',
                amount: 0,
                description: '',
                category: 'Other',
                account: 'Unknown',
                balance: null,
                payee: '',
                originalRow: row
            };

            // Find date field
            const dateField = headers.find(h => /date/i.test(h));
            if (dateField) {
                transaction.date = parseDate(row[dateField]);
            }

            // Find amount field
            const amountField = headers.find(h => /amount|value|debit|credit/i.test(h));
            if (amountField) {
                transaction.amount = parseAmount(row[amountField]);
            }

            // Find description field
            const descField = headers.find(h => /desc|memo|detail|payee|merchant|reference/i.test(h));
            if (descField) {
                transaction.description = String(row[descField] || '').trim();
            }

            // Find payee field
            const payeeField = headers.find(h => /payee|merchant|vendor/i.test(h));
            if (payeeField && payeeField !== descField) {
                transaction.payee = String(row[payeeField] || '').trim();
            }

            // Find balance field
            const balanceField = headers.find(h => /balance/i.test(h));
            if (balanceField) {
                transaction.balance = parseAmount(row[balanceField]);
            }

            return transaction;
        }

        function findValueByPattern(row, pattern) {
            const key = Object.keys(row).find(k => pattern.test(k));
            return key ? row[key] : null;
        }

        function parseDate(dateValue) {
            if (!dateValue) return '';
            
            try {
                // Handle various date formats
                let date;
                if (typeof dateValue === 'string') {
                    // Try different date formats common in NZ
                    const formats = [
                        /(\d{1,2})\/(\d{1,2})\/(\d{4})/, // DD/MM/YYYY
                        /(\d{4})-(\d{1,2})-(\d{1,2})/, // YYYY-MM-DD
                        /(\d{1,2})-(\d{1,2})-(\d{4})/, // DD-MM-YYYY
                    ];
                    
                    for (const format of formats) {
                        const match = dateValue.match(format);
                        if (match) {
                            if (format === formats[1]) { // YYYY-MM-DD
                                date = new Date(match[1], match[2] - 1, match[3]);
                            } else { // DD/MM/YYYY or DD-MM-YYYY
                                date = new Date(match[3], match[2] - 1, match[1]);
                            }
                            break;
                        }
                    }
                    
                    if (!date) {
                        date = new Date(dateValue);
                    }
                } else {
                    date = new Date(dateValue);
                }

                if (isNaN(date.getTime())) {
                    return '';
                }

                return date.toISOString().split('T')[0]; // YYYY-MM-DD format
            } catch (error) {
                console.warn('Date parsing error:', error, dateValue);
                return '';
            }
        }

        function parseAmount(amountValue) {
            if (amountValue === null || amountValue === undefined || amountValue === '') {
                return 0;
            }

            // Convert to string and clean
            let cleanAmount = String(amountValue)
                .replace(/[,$\s]/g, '') // Remove currency symbols, commas, spaces
                .replace(/[()]/g, ''); // Remove parentheses

            // Handle negative amounts in parentheses
            if (String(amountValue).includes('(') && String(amountValue).includes(')')) {
                cleanAmount = '-' + cleanAmount;
            }

            const parsed = parseFloat(cleanAmount);
            return isNaN(parsed) ? 0 : parsed;
        }

        function categorizeTransaction(description, payee) {
            const text = `${description} ${payee}`.toLowerCase();
            
            // Grocery stores
            if (/countdown|new world|pak.*save|fresh choice|four square|supermarket/i.test(text)) {
                return 'Groceries';
            }
            
            // Dining out
            if (/mcdonald|kfc|burger king|subway|restaurant|cafe|pizza|uber eats|menulog/i.test(text)) {
                return 'Dining Out';
            }
            
            // Fuel
            if (/bp|z energy|mobil|caltex|gull|fuel|petrol|gas station/i.test(text)) {
                return 'Fuel';
            }
            
            // Utilities
            if (/meridian|contact energy|electric|power|genesis|trustpower|water|gas/i.test(text)) {
                return 'Utilities';
            }
            
            // Entertainment
            if (/sky|netflix|spotify|disney|prime|cinema|movie|entertainment/i.test(text)) {
                return 'Entertainment';
            }
            
            // Transport
            if (/metlink|at hop|bus|train|taxi|uber|lyft|ferry/i.test(text)) {
                return 'Transportation';
            }
            
            // Shopping
            if (/warehouse|kmart|bunnings|mitre|clothing|shoes|amazon|trademe/i.test(text)) {
                return 'Shopping';
            }
            
            // Banking
            if (/anz|asb|bnz|kiwibank|westpac|tsb|interest|fee|atm/i.test(text)) {
                return 'Banking';
            }
            
            // Health
            if (/pharmacy|doctor|medical|hospital|dentist|physio/i.test(text)) {
                return 'Healthcare';
            }
            
            // Income indicators
            if (/salary|wage|pay|income|deposit|transfer in/i.test(text)) {
                return 'Income';
            }

            return 'Other';
        }

        function removeFile(fileId) {
            const index = uploadedFiles.findIndex(f => f.id == fileId);
            if (index > -1) {
                const removedFile = uploadedFiles.splice(index, 1)[0];
                
                // Remove transactions from processed list
                if (removedFile.status === 'success') {
                    processedTransactions = processedTransactions.filter(t => 
                        !removedFile.transactions.some(ft => ft.id === t.id)
                    );
                    updateFinancialFigures();
                    saveTransactionsToStorage();
                }
                
                renderFileList();
                showUploadActions();
                
                if (uploadedFiles.length === 0) {
                    document.getElementById('resultsContainer').style.display = 'none';
                }
            }
        }

        function clearAllFiles() {
            if (confirm('Are you sure you want to clear all files? This will remove all uploaded data.')) {
                uploadedFiles = [];
                processedTransactions = [];
                totalStats = { transactions: 0, income: 0, expenses: 0, netChange: 0 };
                
                renderFileList();
                showUploadActions();
                updateFinancialFigures();
                document.getElementById('resultsContainer').style.display = 'none';
                
                // Clear from storage
                localStorage.removeItem('financeos_transactions');
            }
        }

        function updateFinancialFigures() {
            // Calculate totals
            totalStats.transactions = processedTransactions.length;
            totalStats.income = processedTransactions
                .filter(t => t.amount > 0)
                .reduce((sum, t) => sum + t.amount, 0);
            totalStats.expenses = Math.abs(processedTransactions
                .filter(t => t.amount < 0)
                .reduce((sum, t) => sum + t.amount, 0));
            totalStats.netChange = totalStats.income - totalStats.expenses;

            // Update summary cards
            const summaryCards = document.getElementById('summaryCards');
            if (processedTransactions.length > 0) {
                summaryCards.style.display = 'grid';
                
                document.getElementById('totalTransactions').textContent = totalStats.transactions;
                document.getElementById('totalIncome').textContent = formatCurrency(totalStats.income);
                document.getElementById('totalExpenses').textContent = formatCurrency(totalStats.expenses);
                
                const netChangeEl = document.getElementById('netChange');
                netChangeEl.textContent = formatCurrency(totalStats.netChange);
                netChangeEl.className = totalStats.netChange >= 0 ? 'value positive' : 'value negative';
            }

            // Update dashboard figures in localStorage for other pages
            updateDashboardData();
        }

        function updateDashboardData() {
            try {
                // Get existing dashboard data
                const existingData = JSON.parse(localStorage.getItem('financeos_dashboard_data') || '{}');
                
                // Update with new transaction data
                existingData.lastUpdate = new Date().toISOString();
                existingData.totalTransactions = totalStats.transactions;
                existingData.recentIncome = totalStats.income;
                existingData.recentExpenses = totalStats.expenses;
                existingData.netCashFlow = totalStats.netChange;
                
                // Calculate monthly spending (approximate)
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const recentTransactions = processedTransactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate >= thirtyDaysAgo;
                });
                
                existingData.monthlySpending = Math.abs(recentTransactions
                    .filter(t => t.amount < 0)
                    .reduce((sum, t) => sum + t.amount, 0));

                localStorage.setItem('financeos_dashboard_data', JSON.stringify(existingData));
                console.log('Dashboard data updated:', existingData);
            } catch (error) {
                console.error('Error updating dashboard data:', error);
            }
        }

        function saveTransactionsToStorage() {
            try {
                localStorage.setItem('financeos_transactions', JSON.stringify(processedTransactions));
                localStorage.setItem('financeos_last_csv_upload', new Date().toISOString());
                console.log(`Saved ${processedTransactions.length} transactions to storage`);
            } catch (error) {
                console.error('Error saving to storage:', error);
            }
        }

        function loadExistingData() {
            try {
                const savedTransactions = localStorage.getItem('financeos_transactions');
                if (savedTransactions) {
                    processedTransactions = JSON.parse(savedTransactions);
                    updateFinancialFigures();
                    
                    if (processedTransactions.length > 0) {
                        showProcessingResults();
                    }
                }
            } catch (error) {
                console.error('Error loading existing data:', error);
            }
        }

        function showProcessingResults() {
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsTitle = document.getElementById('resultsTitle');
            const resultsContent = document.getElementById('resultsContent');
            
            resultsContainer.style.display = 'block';
            resultsTitle.style.display = 'block';

            // Show transaction preview
            const recentTransactions = processedTransactions.slice(-10); // Last 10 transactions
            
            const html = `
                <div class="result-card glass-premium">
                    <div class="result-header">
                        <div class="result-title">Recent Transactions</div>
                        <div class="result-status status-success">Processed</div>
                    </div>
                    <div class="transaction-preview">
                        ${recentTransactions.map(t => `
                            <div class="transaction-item">
                                <div class="transaction-details">
                                    <div class="transaction-description">${t.description}</div>
                                    <div class="transaction-meta">${t.date} • ${t.category}</div>
                                </div>
                                <div class="transaction-amount ${t.amount >= 0 ? 'amount-positive' : 'amount-negative'}">
                                    ${formatCurrency(Math.abs(t.amount))}
                                </div>
                            </div>
                        `).join('')}
                        ${processedTransactions.length > 10 ? `
                            <div style="text-align: center; padding: 12px; color: var(--text-muted); font-size: 12px;">
                                Showing last 10 of ${processedTransactions.length} transactions
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            resultsContent.innerHTML = html;

            // Add success animation
            resultsContainer.classList.add('success-animation');
            setTimeout(() => {
                resultsContainer.classList.remove('success-animation');
            }, 600);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-NZ', {
                style: 'currency',
                currency: 'NZD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(Math.abs(amount));
        }

        function togglePrivacyMode() {
            const isPrivate = document.body.classList.toggle('privacy-mode');
            const toggle = document.getElementById('privacyToggle');
            if (toggle) {
                toggle.textContent = isPrivate ? '🔓 Show Data' : '🔒 Privacy';
            }
            localStorage.setItem('financeos_privacy', isPrivate.toString());
        }

        // Initialize privacy mode from localStorage
        document.addEventListener('DOMContentLoaded', function() {
            const savedPrivacy = localStorage.getItem('financeos_privacy');
            if (savedPrivacy === 'true') {
                togglePrivacyMode();
            }
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + U for upload
            if ((e.ctrlKey || e.metaKey) && e.key === 'u') {
                e.preventDefault();
                document.getElementById('fileInput').click();
            }
            
            // Escape to clear all
            if (e.key === 'Escape' && uploadedFiles.length > 0) {
                clearAllFiles();
            }
        });

        console.log('FinanceOS CSV Upload System initialized');
    </script>
</body>
</html>