<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceOS - Upload Bank Statements</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#8b5cf6">
    <link rel="stylesheet" href="styles.css">
    <style>
        .upload-zone {
            border: 2px dashed rgba(139, 92, 246, 0.5);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 30px;
        }
        
        .upload-zone.dragover {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
            transform: scale(1.02);
        }
        
        .upload-zone.processing {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.7;
        }
        
        .upload-text {
            color: white;
            font-size: 18px;
            margin-bottom: 15px;
        }
        
        .upload-hint {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .upload-button {
            background: linear-gradient(135deg, #8b5cf6, #9333ea);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(139, 92, 246, 0.4);
        }
        
        .bank-formats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }
        
        .bank-format-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }
        
        .bank-logo {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .bank-name {
            color: white;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .bank-status {
            color: #10b981;
            font-size: 12px;
        }
        
        .processing-results {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            display: none;
        }
        
        .processing-results.success {
            border: 1px solid rgba(16, 185, 129, 0.3);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .processing-results.error {
            border: 1px solid rgba(239, 68, 68, 0.3);
            background: rgba(239, 68, 68, 0.1);
        }
        
        .result-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .result-icon {
            font-size: 24px;
        }
        
        .result-title {
            color: white;
            font-weight: 600;
            font-size: 18px;
        }
        
        .result-details {
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
        }
        
        .transaction-preview {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        
        .transaction-desc {
            color: white;
            font-weight: 500;
        }
        
        .transaction-amount {
            font-weight: 600;
        }
        
        .transaction-amount.positive {
            color: #10b981;
        }
        
        .transaction-amount.negative {
            color: #ef4444;
        }
        
        .transaction-category {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            margin-top: 2px;
        }
        
        .ai-insights {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(59, 130, 246, 0.15));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
        }
        
        .ai-title {
            color: white;
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .insight-item {
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .insight-type {
            color: #8b5cf6;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .insight-text {
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.5;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-details {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header glass">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">$</div>
                <span class="logo-text">FinanceOS</span>
            </div>
            
            <nav class="nav">
                <a href="index.html" class="nav-button">Dashboard</a>
                <a href="csv-upload.html" class="nav-button active">Upload CSV</a>
                <a href="goals.html" class="nav-button">Goals</a>
                <button class="privacy-toggle" id="privacyToggle">üîí Privacy Mode</button>
                <button class="nav-button" id="notificationSettings">üîî Notifications</button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <section class="page-header">
            <h1 class="page-title">üì§ Upload Bank Statements</h1>
            <p class="page-subtitle">
                Upload your weekly CSV bank statements to automatically categorize transactions and update your financial data
            </p>
        </section>

        <!-- Upload Zone -->
        <section class="upload-section">
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Drag and drop your CSV files here</div>
                <div class="upload-hint">Supports ANZ, ASB, BNZ, Westpac, and Kiwibank formats</div>
                
                <div class="file-input-wrapper">
                    <input type="file" class="file-input" id="csvFileInput" accept=".csv,.xlsx,.xls" multiple>
                    <button class="upload-button">Choose Files</button>
                </div>
            </div>
        </section>

        <!-- Supported Bank Formats -->
        <section class="supported-banks">
            <h2 class="section-title">Supported Bank Formats</h2>
            <div class="bank-formats">
                <div class="bank-format-card">
                    <div class="bank-logo">üè¶</div>
                    <div class="bank-name">ANZ</div>
                    <div class="bank-status">‚úÖ Supported</div>
                </div>
                <div class="bank-format-card">
                    <div class="bank-logo">üèõÔ∏è</div>
                    <div class="bank-name">ASB</div>
                    <div class="bank-status">‚úÖ Supported</div>
                </div>
                <div class="bank-format-card">
                    <div class="bank-logo">üè¢</div>
                    <div class="bank-name">BNZ</div>
                    <div class="bank-status">‚úÖ Supported</div>
                </div>
                <div class="bank-format-card">
                    <div class="bank-logo">üè™</div>
                    <div class="bank-name">Westpac</div>
                    <div class="bank-status">‚úÖ Supported</div>
                </div>
                <div class="bank-format-card">
                    <div class="bank-logo">ü•ù</div>
                    <div class="bank-name">Kiwibank</div>
                    <div class="bank-status">‚úÖ Supported</div>
                </div>
            </div>
        </section>

        <!-- Processing Results -->
        <section class="processing-results" id="processingResults">
            <div class="result-header">
                <span class="result-icon"></span>
                <span class="result-title"></span>
            </div>
            <div class="result-details"></div>
            <div class="transaction-preview" id="transactionPreview"></div>
        </section>

        <!-- AI Insights -->
        <section class="ai-insights" id="aiInsights" style="display: none;">
            <div class="ai-title">
                ü§ñ AI Analysis
            </div>
            <div id="insightsList"></div>
        </section>

        <!-- Quick Actions -->
        <section class="quick-actions">
            <a href="index.html" class="action-button">
                üìä View Dashboard
            </a>
            <a href="goals.html" class="action-button">
                üéØ Update Goals
            </a>
            <button class="action-button" onclick="clearAllData()">
                üóëÔ∏è Clear All Data
            </button>
            <button class="action-button" onclick="downloadSampleCSV()">
                üìã Download Sample
            </button>
        </section>
    </main>

    <script src="data-manager.js"></script>
    <script src="notification-system.js"></script>
    <script>
        // Global variables
        let uploadZone, fileInput, processingResults, aiInsights;
        let isProcessing = false;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            uploadZone = document.getElementById('uploadZone');
            fileInput = document.getElementById('csvFileInput');
            processingResults = document.getElementById('processingResults');
            aiInsights = document.getElementById('aiInsights');

            setupEventListeners();
            checkExistingData();
            
            // Privacy mode setup
            setupPrivacyMode();
        });

        function setupEventListeners() {
            // File input change
            fileInput.addEventListener('change', handleFileSelect);

            // Drag and drop events
            uploadZone.addEventListener('dragover', handleDragOver);
            uploadZone.addEventListener('dragleave', handleDragLeave);
            uploadZone.addEventListener('drop', handleDrop);

            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            // Notification settings
            document.getElementById('notificationSettings').addEventListener('click', () => {
                if (window.FinanceOSNotifications) {
                    window.FinanceOSNotifications.showNotificationSettings();
                }
            });
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDragOver(e) {
            uploadZone.classList.add('dragover');
        }

        function handleDragLeave(e) {
            uploadZone.classList.remove('dragover');
        }

        function handleDrop(e) {
            uploadZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            processFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            processFiles(files);
        }

        async function processFiles(files) {
            if (isProcessing) return;
            if (files.length === 0) return;

            isProcessing = true;
            uploadZone.classList.add('processing');
            
            // Update upload zone
            uploadZone.innerHTML = `
                <div class="upload-icon">‚è≥</div>
                <div class="upload-text">Processing ${files.length} file(s)...</div>
                <div class="upload-hint">
                    <span class="loading-spinner"></span>
                    Please wait while we analyze your bank statements
                </div>
            `;

            let totalTransactions = 0;
            let processedFiles = 0;
            let errors = [];

            for (let file of files) {
                try {
                    const result = await processFile(file);
                    if (result.success) {
                        totalTransactions += result.transactions;
                        processedFiles++;
                    } else {
                        errors.push(`${file.name}: ${result.error}`);
                    }
                } catch (error) {
                    errors.push(`${file.name}: ${error.message}`);
                }
            }

            // Show results
            showProcessingResults(processedFiles, totalTransactions, errors);
            
            // Generate AI insights
            if (totalTransactions > 0) {
                generateAIInsights();
            }

            // Reset upload zone
            resetUploadZone();
            isProcessing = false;

            // Send success notification
            if (window.FinanceOSNotifications && totalTransactions > 0) {
                window.FinanceOSNotifications.sendNotification('üì§ CSV Upload Complete', {
                    body: `Successfully processed ${totalTransactions} transactions from ${processedFiles} file(s)`,
                    tag: 'csv-upload-success'
                });
            }
        }

        async function processFile(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const csvText = e.target.result;
                    const result = window.FinanceOSDataManager.processCSV(csvText, file.name);
                    resolve(result);
                };
                
                reader.onerror = function() {
                    resolve({ success: false, error: 'Failed to read file' });
                };
                
                reader.readAsText(file);
            });
        }

        function showProcessingResults(processedFiles, totalTransactions, errors) {
            const hasErrors = errors.length > 0;
            const hasSuccess = totalTransactions > 0;

            if (hasSuccess) {
                processingResults.className = 'processing-results success';
                processingResults.querySelector('.result-icon').textContent = '‚úÖ';
                processingResults.querySelector('.result-title').textContent = 'Upload Successful';
                
                let details = `Successfully processed ${totalTransactions} transactions from ${processedFiles} file(s).`;
                
                if (hasErrors) {
                    details += `\n\n‚ö†Ô∏è Some files had issues:\n${errors.join('\n')}`;
                }
                
                processingResults.querySelector('.result-details').textContent = details;
                
                // Show transaction preview
                showTransactionPreview();
                
            } else {
                processingResults.className = 'processing-results error';
                processingResults.querySelector('.result-icon').textContent = '‚ùå';
                processingResults.querySelector('.result-title').textContent = 'Upload Failed';
                processingResults.querySelector('.result-details').textContent = `No transactions were processed.\n\nErrors:\n${errors.join('\n')}`;
            }

            processingResults.style.display = 'block';
        }

        function showTransactionPreview() {
            const recentTransactions = window.FinanceOSDataManager.getRecentTransactions(10);
            const preview = document.getElementById('transactionPreview');
            
            if (recentTransactions.length === 0) {
                preview.innerHTML = '<p style="color: rgba(255,255,255,0.7);">No transactions to preview</p>';
                return;
            }

            preview.innerHTML = `
                <h4 style="color: white; margin-bottom: 15px;">Recent Transactions Preview:</h4>
                ${recentTransactions.map(transaction => `
                    <div class="transaction-item">
                        <div>
                            <div class="transaction-desc">${transaction.description}</div>
                            <div class="transaction-category">${transaction.category} ‚Ä¢ ${window.FinanceOSDataManager.formatDate(transaction.date)}</div>
                        </div>
                        <div class="transaction-amount ${transaction.amount >= 0 ? 'positive' : 'negative'}">
                            ${window.FinanceOSDataManager.formatCurrency(transaction.amount)}
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function generateAIInsights() {
            const dataManager = window.FinanceOSDataManager;
            const recentTransactions = dataManager.getRecentTransactions(50);
            const budgetStatus = dataManager.getBudgetStatus();
            
            const insights = [];

            // Spending pattern analysis
            const categories = {};
            recentTransactions.forEach(t => {
                if (t.amount < 0) {
                    categories[t.category] = (categories[t.category] || 0) + Math.abs(t.amount);
                }
            });

            const topCategory = Object.entries(categories).sort((a, b) => b[1] - a[1])[0];
            if (topCategory) {
                insights.push({
                    type: 'Spending Pattern',
                    text: `Your highest spending category is ${topCategory[0]} with ${dataManager.formatCurrency(topCategory[1])} in recent transactions.`
                });
            }

            // Budget analysis
            const overBudgetCategories = budgetStatus.filter(cat => cat.percentage > 100);
            if (overBudgetCategories.length > 0) {
                insights.push({
                    type: 'Budget Alert',
                    text: `${overBudgetCategories.length} categories are over budget: ${overBudgetCategories.map(cat => cat.name).join(', ')}. Consider reducing spending in these areas.`
                });
            }

            // Income detection
            const income = recentTransactions.filter(t => t.amount > 0 && t.amount > 1000);
            if (income.length > 0) {
                const totalIncome = income.reduce((sum, t) => sum + t.amount, 0);
                insights.push({
                    type: 'Income Detected',
                    text: `Found ${dataManager.formatCurrency(totalIncome)} in income from ${income.length} transaction(s). Make sure this is properly allocated to your emergency fund and goals.`
                });
            }

            // Unusual spending detection
            const largeExpenses = recentTransactions.filter(t => t.amount < -500);
            if (largeExpenses.length > 0) {
                insights.push({
                    type: 'Large Expenses',
                    text: `Detected ${largeExpenses.length} transaction(s) over $500. Review these carefully: ${largeExpenses.slice(0, 3).map(t => t.description).join(', ')}.`
                });
            }

            // Emergency fund reminder
            insights.push({
                type: 'Emergency Fund',
                text: 'Remember: Your emergency fund is critically low at $0.17. Prioritize building this to at least $1,000 before focusing on other goals.'
            });

            displayAIInsights(insights);
        }

        function displayAIInsights(insights) {
            const insightsList = document.getElementById('insightsList');
            
            insightsList.innerHTML = insights.map(insight => `
                <div class="insight-item">
                    <div class="insight-type">${insight.type}</div>
                    <div class="insight-text">${insight.text}</div>
                </div>
            `).join('');

            aiInsights.style.display = 'block';
        }

        function resetUploadZone() {
            uploadZone.classList.remove('processing');
            uploadZone.innerHTML = `
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Drag and drop your CSV files here</div>
                <div class="upload-hint">Supports ANZ, ASB, BNZ, Westpac, and Kiwibank formats</div>
                
                <div class="file-input-wrapper">
                    <input type="file" class="file-input" id="csvFileInput" accept=".csv,.xlsx,.xls" multiple>
                    <button class="upload-button">Choose Files</button>
                </div>
            `;
            
            // Re-setup file input
            fileInput = document.getElementById('csvFileInput');
            fileInput.addEventListener('change', handleFileSelect);
        }

        function checkExistingData() {
            const csvData = localStorage.getItem('csvData');
            if (csvData) {
                const data = JSON.parse(csvData);
                const uploadDate = localStorage.getItem('csvUploadDate');
                
                if (data.length > 0) {
                    const summary = document.createElement('div');
                    summary.className = 'processing-results success';
                    summary.style.display = 'block';
                    summary.innerHTML = `
                        <div class="result-header">
                            <span class="result-icon">üìä</span>
                            <span class="result-title">Existing Data Found</span>
                        </div>
                        <div class="result-details">
                            ${data.length} transactions loaded from previous uploads.
                            Last updated: ${new Date(uploadDate).toLocaleDateString()}
                        </div>
                    `;
                    
                    document.querySelector('.upload-section').appendChild(summary);
                }
            }
        }

        function setupPrivacyMode() {
            const privacyToggle = document.getElementById('privacyToggle');
            const mainContent = document.getElementById('mainContent');
            
            let privacyMode = localStorage.getItem('privacyMode') === 'true';
            updatePrivacyMode();

            privacyToggle.addEventListener('click', () => {
                privacyMode = !privacyMode;
                localStorage.setItem('privacyMode', privacyMode);
                updatePrivacyMode();
            });

            function updatePrivacyMode() {
                if (privacyMode) {
                    mainContent.classList.add('privacy-mode');
                    privacyToggle.textContent = 'üîì Show Data';
                    privacyToggle.classList.add('active');
                } else {
                    mainContent.classList.remove('privacy-mode');
                    privacyToggle.textContent = 'üîí Privacy Mode';
                    privacyToggle.classList.remove('active');
                }
            }
        }

        // Utility functions
        function clearAllData() {
            if (confirm('Are you sure you want to clear all uploaded data? This cannot be undone.')) {
                localStorage.removeItem('csvData');
                localStorage.removeItem('csvUploadDate');
                localStorage.removeItem('transactions');
                
                if (window.FinanceOSDataManager) {
                    window.FinanceOSDataManager.csvData = [];
                    window.FinanceOSDataManager.transactions = [];
                }
                
                alert('All data cleared successfully.');
                location.reload();
            }
        }

        function downloadSampleCSV() {
            const sampleData = `Date,Amount,Description,Balance
01/06/2025,-25.50,"COUNTDOWN CHRISTCHURCH",1234.50
02/06/2025,2500.00,"PATHWAY ENGINEER SALARY",3734.00
03/06/2025,-80.00,"Z ENERGY CHRISTCHURCH",3654.00
04/06/2025,-120.00,"NEW WORLD GROCERY",3534.00
05/06/2025,-15.00,"CAFE COFFEE",3519.00`;

            const blob = new Blob([sampleData], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sample-bank-statement.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        console.log('FinanceOS CSV Upload page loaded successfully');
    </script>
</body>
</html>