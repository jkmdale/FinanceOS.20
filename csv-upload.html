<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceOS - Upload Bank Statements</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#8b5cf6">
    <link rel="stylesheet" href="styles.css">
    <style>
        .upload-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* MOBILE-OPTIMIZED FILE INPUT */
        .file-input-wrapper {
            position: relative;
            display: block;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .file-input-real {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 10;
            font-size: 0; /* iOS fix */
        }
        
        .file-input-visual {
            display: block;
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, #8b5cf6, #9333ea);
            color: white;
            text-align: center;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        
        .file-input-visual:active {
            transform: scale(0.98);
            background: linear-gradient(135deg, #7c3aed, #8b5cf6);
        }
        
        .upload-zone {
            border: 3px dashed #8b5cf6;
            border-radius: 20px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            background: rgba(139, 92, 246, 0.05);
            margin-bottom: 30px;
            position: relative;
        }
        
        .upload-zone.dragover {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.8;
        }
        
        .upload-text {
            color: white;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.4;
        }
        
        .file-preview {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            display: none;
        }
        
        .file-preview.show {
            display: block;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
        }
        
        .file-info {
            flex: 1;
            min-width: 0;
        }
        
        .file-name {
            color: white;
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 4px;
            word-break: break-all;
        }
        
        .file-size {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
        }
        
        .file-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
            margin-left: 8px;
        }
        
        .status-ready {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .status-processing {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .status-success {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .status-error {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .process-button {
            width: 100%;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 18px;
            margin-top: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .process-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        }
        
        .process-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .results-section {
            margin-top: 30px;
            padding: 20px;
            border-radius: 15px;
            display: none;
        }
        
        .results-section.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .results-section.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .remove-file {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            margin-left: 8px;
            white-space: nowrap;
        }
        
        .remove-file:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        .clear-all-btn {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-left: auto;
        }
        
        .clear-all-btn:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        .mobile-instructions {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            color: #60a5fa;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .debug-section {
            background: rgba(255, 255, 0, 0.1);
            border: 1px solid rgba(255, 255, 0, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin: 15px 0;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            display: none;
        }
        
        .test-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 10px 0;
        }
        
        .test-btn {
            padding: 8px 12px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .upload-container {
                padding: 15px;
            }
            
            .file-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .file-status, .remove-file {
                margin-left: 0;
                align-self: flex-end;
            }
            
            .upload-zone {
                padding: 30px 15px;
            }
            
            .upload-text {
                font-size: 18px;
            }
            
            .upload-hint {
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header glass">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">$</div>
                <span class="logo-text">FinanceOS</span>
            </div>
            
            <nav class="nav">
                <a href="index.html" class="nav-button">Dashboard</a>
                <a href="csv-upload.html" class="nav-button active">Upload CSV</a>
                <a href="goals.html" class="nav-button">Goals</a>
                <button class="privacy-toggle" id="privacyToggle">üîí Privacy Mode</button>
                <button class="logout-button" onclick="logout()">üö™ Logout</button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="upload-container">
            <section class="page-header">
                <h1 class="page-title">üì§ Upload Bank Statements</h1>
                <p class="page-subtitle">
                    Upload your CSV bank statements to automatically categorize transactions
                </p>
            </section>

            <!-- Mobile Instructions -->
            <div class="mobile-instructions">
                üì± <strong>Mobile Instructions:</strong><br>
                1. Tap the blue "Select Files" button below<br>
                2. Choose "Browse" or "Documents" in the popup<br>
                3. Navigate to your Downloads folder<br>
                4. Select your CSV transaction files<br>
                5. Tap "Done" or "Open"
            </div>

            <!-- Debug Section -->
            <div class="debug-section" id="debugSection">
                <strong>Debug Info:</strong> <span id="debugText">Ready...</span>
                <div class="test-buttons">
                    <button class="test-btn" onclick="testFileInput()">Test Input</button>
                    <button class="test-btn" onclick="testMobile()">Test Mobile</button>
                    <button class="test-btn" onclick="showFileDialog()">Force Dialog</button>
                </div>
            </div>

            <!-- MOBILE-OPTIMIZED FILE INPUT -->
            <div class="file-input-wrapper">
                <input type="file" 
                       id="fileInput" 
                       class="file-input-real" 
                       accept=".csv,.xlsx,.xls,text/csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" 
                       multiple
                       capture="environment">
                
                <div class="file-input-visual" id="fileInputVisual">
                    üìÇ Select CSV Files to Upload
                </div>
            </div>

            <!-- Alternative Upload Zone -->
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Alternative: Drag & Drop Files Here</div>
                <div class="upload-hint">
                    CSV files from ANZ, ASB, BNZ, Westpac, Kiwibank<br>
                    Maximum file size: 10MB per file
                </div>
            </div>

            <!-- File Preview -->
            <div class="file-preview" id="filePreview">
                <h3 style="color: white; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    üìã Selected Files (<span id="fileCount">0</span>)
                    <button class="clear-all-btn" onclick="clearAllFiles()">Clear All</button>
                </h3>
                <div id="fileList"></div>
                
                <button class="process-button" id="processButton" onclick="processFiles()">
                    ‚ö° Process <span id="processCount">0</span> Files
                </button>
            </div>

            <!-- Results -->
            <div class="results-section" id="resultsSection">
                <h3 id="resultsTitle" style="color: white; margin-bottom: 15px;"></h3>
                <div id="resultsContent"></div>
            </div>

            <!-- Quick Actions -->
            <section class="quick-actions" style="margin-top: 40px;">
                <a href="index.html" class="action-button">üìä View Dashboard</a>
                <a href="goals.html" class="action-button">üéØ Update Goals</a>
                <button class="action-button" onclick="showDebug()">üêõ Show Debug</button>
                <button class="action-button" onclick="downloadSample()">üìã Sample CSV</button>
            </section>
        </div>
    </main>

    <script>
        let selectedFiles = [];
        let isAuthenticated = false;
        let debugMode = false;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Mobile CSV Upload page loaded');
            checkAuth();
            setupMobileFileUpload();
            setupPrivacyMode();
            detectMobile();
            updateDebug('Page initialized for mobile');
        });

        function updateDebug(message) {
            const debugText = document.getElementById('debugText');
            if (debugText) {
                debugText.textContent = message;
            }
            console.log('üêõ Debug:', message);
        }

        function showDebug() {
            debugMode = true;
            document.getElementById('debugSection').style.display = 'block';
            updateDebug('Debug mode enabled');
        }

        function detectMobile() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isTouch = 'ontouchstart' in window;
            
            updateDebug(`Mobile: ${isMobile}, Touch: ${isTouch}, UserAgent: ${navigator.userAgent.substring(0, 50)}...`);
            
            if (isMobile || isTouch) {
                document.body.classList.add('mobile-device');
            }
        }

        // Simple auth check
        function checkAuth() {
            const token = localStorage.getItem('financeos-token');
            if (!token) {
                window.location.href = 'index.html';
                return;
            }
            isAuthenticated = true;
            updateDebug('Authentication verified');
        }

        function logout() {
            localStorage.removeItem('financeos-token');
            localStorage.removeItem('financeos-last-activity');
            window.location.href = 'index.html';
        }

        // MOBILE-OPTIMIZED file upload setup
        function setupMobileFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const fileInputVisual = document.getElementById('fileInputVisual');
            const uploadZone = document.getElementById('uploadZone');

            updateDebug('Setting up mobile file upload...');

            // Primary method: Direct file input change
            fileInput.addEventListener('change', function(e) {
                updateDebug(`File input changed: ${e.target.files.length} files`);
                handleFileSelect(e);
            });

            // Secondary method: Visual button click
            fileInputVisual.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                updateDebug('Visual button clicked');
                triggerFileInput();
            });

            // Tertiary method: Upload zone click
            uploadZone.addEventListener('click', function(e) {
                e.preventDefault();
                updateDebug('Upload zone clicked');
                triggerFileInput();
            });

            // Touch events for mobile
            fileInputVisual.addEventListener('touchstart', function(e) {
                updateDebug('Touch start on visual button');
                // Don't prevent default - let the browser handle it
            });

            fileInputVisual.addEventListener('touchend', function(e) {
                updateDebug('Touch end on visual button');
                setTimeout(() => triggerFileInput(), 100);
            });

            // Drag and drop (works on some mobile browsers)
            uploadZone.addEventListener('dragover', handleDragOver);
            uploadZone.addEventListener('dragleave', handleDragLeave);
            uploadZone.addEventListener('drop', handleDrop);

            // Prevent defaults
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            updateDebug('Mobile file upload setup complete');
        }

        function triggerFileInput() {
            const fileInput = document.getElementById('fileInput');
            updateDebug('Attempting to trigger file input...');
            
            try {
                // Multiple approaches for mobile compatibility
                if (fileInput.click) {
                    fileInput.click();
                    updateDebug('File input click() triggered');
                } else if (fileInput.dispatchEvent) {
                    const event = new MouseEvent('click', {
                        view: window,
                        bubbles: true,
                        cancelable: true
                    });
                    fileInput.dispatchEvent(event);
                    updateDebug('File input event dispatched');
                }
                
                // Focus for iOS
                if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                    fileInput.focus();
                    updateDebug('iOS focus applied');
                }
                
            } catch (error) {
                updateDebug(`Error triggering file input: ${error.message}`);
                console.error('File input error:', error);
                
                // Fallback: Show instructions
                alert('Please tap directly on the file input area to select files. If this doesn\'t work, try using the browser\'s file menu.');
            }
        }

        function showFileDialog() {
            // Force show file dialog
            const fileInput = document.getElementById('fileInput');
            
            // Create a new file input element
            const newInput = document.createElement('input');
            newInput.type = 'file';
            newInput.accept = '.csv,.xlsx,.xls';
            newInput.multiple = true;
            newInput.style.position = 'absolute';
            newInput.style.left = '-9999px';
            
            newInput.addEventListener('change', function(e) {
                updateDebug(`Force dialog: ${e.target.files.length} files selected`);
                handleFileSelect(e);
                document.body.removeChild(newInput);
            });
            
            document.body.appendChild(newInput);
            newInput.click();
            updateDebug('Force dialog triggered');
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('uploadZone').classList.add('dragover');
            updateDebug('Drag over detected');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            document.getElementById('uploadZone').classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('uploadZone').classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files);
            updateDebug(`Files dropped: ${files.length} files`);
            addFiles(files);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            updateDebug(`Files selected: ${files.length} files`);
            
            // Log file details
            files.forEach((file, index) => {
                updateDebug(`File ${index + 1}: ${file.name} (${file.size} bytes, ${file.type})`);
            });
            
            addFiles(files);
        }

        function addFiles(files) {
            updateDebug(`Processing ${files.length} files...`);
            
            const validFiles = files.filter(file => {
                const isValidType = file.name.toLowerCase().match(/\.(csv|xlsx|xls)$/) || 
                                   file.type.includes('csv') || 
                                   file.type.includes('excel') ||
                                   file.type.includes('spreadsheet');
                const isValidSize = file.size <= 10 * 1024 * 1024; // 10MB limit
                
                if (!isValidType) {
                    alert(`Invalid file type: ${file.name}\nPlease use CSV or Excel files.`);
                    updateDebug(`Invalid type: ${file.name} (type: ${file.type})`);
                    return false;
                }
                
                if (!isValidSize) {
                    alert(`File too large: ${file.name}\nMaximum size is 10MB.`);
                    updateDebug(`Invalid size: ${file.name} (${file.size} bytes)`);
                    return false;
                }
                
                return true;
            });

            if (validFiles.length === 0) {
                updateDebug('No valid files to add');
                return;
            }

            // Add to selected files
            validFiles.forEach(file => {
                const existingIndex = selectedFiles.findIndex(f => f.name === file.name);
                if (existingIndex === -1) {
                    selectedFiles.push({
                        file: file,
                        id: Date.now() + Math.random(),
                        status: 'ready'
                    });
                }
            });

            updateDebug(`Added ${validFiles.length} valid files. Total: ${selectedFiles.length}`);
            displayFiles();
            updateCounts();
        }

        function displayFiles() {
            const filePreview = document.getElementById('filePreview');
            const fileList = document.getElementById('fileList');

            if (selectedFiles.length === 0) {
                filePreview.classList.remove('show');
                updateDebug('No files to display');
                return;
            }

            filePreview.classList.add('show');
            fileList.innerHTML = '';

            selectedFiles.forEach((fileObj, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${fileObj.file.name}</div>
                        <div class="file-size">${formatFileSize(fileObj.file.size)}</div>
                    </div>
                    <div class="file-status status-${fileObj.status}" id="status-${fileObj.id}">
                        ${getStatusText(fileObj.status)}
                    </div>
                    <button class="remove-file" onclick="removeFile(${index})">√ó</button>
                `;
                fileList.appendChild(fileItem);
            });

            updateDebug(`Displayed ${selectedFiles.length} files`);
        }

        function updateCounts() {
            document.getElementById('fileCount').textContent = selectedFiles.length;
            document.getElementById('processCount').textContent = selectedFiles.length;
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateDebug(`Removed file at index ${index}`);
            displayFiles();
            updateCounts();
        }

        function clearAllFiles() {
            selectedFiles = [];
            displayFiles();
            updateCounts();
            document.getElementById('fileInput').value = '';
            updateDebug('All files cleared');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getStatusText(status) {
            switch (status) {
                case 'ready': return 'Ready';
                case 'processing': return 'Processing...';
                case 'success': return 'Success';
                case 'error': return 'Error';
                default: return 'Unknown';
            }
        }

        // File Processing
        function processFiles() {
            if (selectedFiles.length === 0) {
                alert('Please select files to process');
                return;
            }

            updateDebug(`Starting to process ${selectedFiles.length} files`);

            const processButton = document.getElementById('processButton');
            processButton.disabled = true;
            processButton.textContent = '‚ö° Processing...';

            let processedCount = 0;
            let successCount = 0;
            let totalTransactions = 0;

            selectedFiles.forEach((fileObj, index) => {
                // Update status to processing
                fileObj.status = 'processing';
                updateFileStatus(fileObj.id, 'processing');

                // Simulate file processing
                setTimeout(() => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            const content = e.target.result;
                            
                            // Simple CSV parsing simulation
                            const lines = content.split('\n').filter(line => line.trim());
                            const transactionCount = Math.max(0, lines.length - 1); // Minus header
                            
                            // Mark as success
                            fileObj.status = 'success';
                            fileObj.transactionCount = transactionCount;
                            updateFileStatus(fileObj.id, 'success', `${transactionCount} transactions`);
                            
                            successCount++;
                            totalTransactions += transactionCount;
                            
                            updateDebug(`Processed ${fileObj.file.name}: ${transactionCount} transactions`);
                            
                        } catch (error) {
                            console.error('Processing error:', error);
                            fileObj.status = 'error';
                            updateFileStatus(fileObj.id, 'error', 'Failed');
                            updateDebug(`Error processing ${fileObj.file.name}: ${error.message}`);
                        }
                        
                        processedCount++;
                        
                        // All files processed
                        if (processedCount === selectedFiles.length) {
                            finishProcessing(successCount, totalTransactions);
                        }
                    };
                    
                    reader.onerror = function() {
                        fileObj.status = 'error';
                        updateFileStatus(fileObj.id, 'error', 'Read failed');
                        processedCount++;
                        updateDebug(`Failed to read ${fileObj.file.name}`);
                        
                        if (processedCount === selectedFiles.length) {
                            finishProcessing(successCount, totalTransactions);
                        }
                    };
                    
                    reader.readAsText(fileObj.file);
                    
                }, 1000 + (index * 500)); // Stagger processing
            });
        }

        function updateFileStatus(fileId, status, extraText = '') {
            const statusElement = document.getElementById(`status-${fileId}`);
            if (statusElement) {
                statusElement.className = `file-status status-${status}`;
                statusElement.textContent = extraText || getStatusText(status);
            }
        }

        function finishProcessing(successCount, totalTransactions) {
            const processButton = document.getElementById('processButton');
            processButton.disabled = false;
            processButton.textContent = `‚ö° Process ${selectedFiles.length} Files`;

            updateDebug(`Processing complete: ${successCount}/${selectedFiles.length} successful, ${totalTransactions} transactions`);

            // Show results
            showResults(successCount === selectedFiles.length, successCount, totalTransactions);

            // Save data for demo
            if (successCount > 0) {
                saveProcessedData(totalTransactions);
            }
        }

        function showResults(allSuccess, successCount, totalTransactions) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsTitle = document.getElementById('resultsTitle');
            const resultsContent = document.getElementById('resultsContent');

            resultsSection.style.display = 'block';
            
            if (allSuccess) {
                resultsSection.className = 'results-section success';
                resultsTitle.innerHTML = '‚úÖ Upload Successful!';
                resultsContent.innerHTML = `
                    <p style="color: #34d399; font-size: 16px; margin-bottom: 15px;">
                        Successfully processed ${totalTransactions} transactions from ${successCount} file(s).
                    </p>
                    <p style="color: rgba(255, 255, 255, 0.8); font-size: 14px;">
                        Your transactions have been categorized and added to your financial data.
                        <br><br>
                        <a href="index.html" style="color: #60a5fa; text-decoration: none; font-weight: 600;">üìä View Dashboard ‚Üí</a>
                    </p>
                `;
            } else {
                resultsSection.className = 'results-section error';
                resultsTitle