<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceOS - Upload Bank Statements</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#8b5cf6">
    <link rel="stylesheet" href="styles.css">
    <style>
        .upload-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .upload-zone {
            border: 3px dashed #8b5cf6;
            border-radius: 20px;
            padding: 60px 40px;
            text-align: center;
            transition: all 0.3s ease;
            background: rgba(139, 92, 246, 0.05);
            margin-bottom: 30px;
            cursor: pointer;
            position: relative;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .upload-zone.dragover {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
            transform: scale(1.02);
        }
        
        .upload-zone:hover {
            border-color: #a855f7;
            background: rgba(139, 92, 246, 0.1);
        }
        
        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 10;
        }
        
        .upload-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.8;
        }
        
        .upload-text {
            color: white;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .upload-hint {
            color: rgba(255, 255, 255, 0.7);
            font-size: 16px;
            margin-bottom: 30px;
            line-height: 1.5;
        }
        
        .upload-button {
            background: linear-gradient(135deg, #8b5cf6, #9333ea);
            color: white;
            padding: 16px 40px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            z-index: 20;
            position: relative;
            pointer-events: none; /* Prevent interfering with file input */
        }
        
        .manual-upload-button {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 16px 40px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .manual-upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
        }
        
        .file-preview {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            display: none;
        }
        
        .file-preview.show {
            display: block;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            color: white;
            font-weight: 500;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .file-size {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }
        
        .file-status {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-ready {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .status-processing {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .status-success {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .status-error {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .process-button {
            width: 100%;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 18px;
            margin-top: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .process-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        }
        
        .process-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .results-section {
            margin-top: 30px;
            padding: 20px;
            border-radius: 15px;
            display: none;
        }
        
        .results-section.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .results-section.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .remove-file {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .remove-file:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        .sample-data {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            overflow-x: auto;
        }
        
        @media (max-width: 768px) {
            .upload-container {
                padding: 15px;
            }
            
            .upload-zone {
                padding: 40px 20px;
                min-height: 180px;
            }
            
            .upload-text {
                font-size: 20px;
            }
            
            .upload-hint {
                font-size: 14px;
            }
            
            .file-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .file-status {
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header glass">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">$</div>
                <span class="logo-text">FinanceOS</span>
            </div>
            
            <nav class="nav">
                <a href="index.html" class="nav-button">Dashboard</a>
                <a href="csv-upload.html" class="nav-button active">Upload CSV</a>
                <a href="goals.html" class="nav-button">Goals</a>
                <button class="privacy-toggle" id="privacyToggle">üîí Privacy Mode</button>
                <button class="logout-button" onclick="logout()">üö™ Logout</button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="upload-container">
            <section class="page-header">
                <h1 class="page-title">üì§ Upload Bank Statements</h1>
                <p class="page-subtitle">
                    Upload your weekly CSV/Excel bank statements to automatically categorize transactions and update your financial data
                </p>
            </section>

            <!-- Upload Zone -->
            <div class="upload-zone" id="uploadZone">
                <input type="file" 
                       id="fileInput" 
                       class="file-input" 
                       accept=".csv,.xlsx,.xls" 
                       multiple>
                
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Drop files here or click to browse</div>
                <div class="upload-hint">
                    Supports CSV and Excel files from ANZ, ASB, BNZ, Westpac, and Kiwibank<br>
                    Maximum file size: 10MB per file
                </div>
                
                <div class="upload-button">
                    üìÇ Choose Files
                </div>
            </div>
            
            <!-- Alternative upload method -->
            <div style="text-align: center;">
                <button type="button" class="manual-upload-button" onclick="triggerFileInput()">
                    üìã Browse for Files Manually
                </button>
            </div>

            <!-- File Preview -->
            <div class="file-preview" id="filePreview">
                <h3 style="color: white; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    üìã Selected Files
                    <button class="remove-file" onclick="clearAllFiles()" style="margin-left: auto;">Clear All</button>
                </h3>
                <div id="fileList"></div>
                
                <button class="process-button" id="processButton" onclick="processFiles()">
                    ‚ö° Process Files
                </button>
            </div>

            <!-- Processing Status -->
            <div id="processingStatus" style="display: none; text-align: center; margin: 20px 0;">
                <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 10px; padding: 20px;">
                    <div style="font-size: 24px; margin-bottom: 10px;">‚ö°</div>
                    <div style="color: #fbbf24; font-weight: 600;">Processing your files...</div>
                    <div style="color: rgba(255, 255, 255, 0.7); font-size: 14px; margin-top: 5px;">This may take a few moments</div>
                </div>
            </div>

            <!-- Results -->
            <div class="results-section" id="resultsSection">
                <h3 id="resultsTitle" style="color: white; margin-bottom: 15px;"></h3>
                <div id="resultsContent"></div>
            </div>

            <!-- Quick Actions -->
            <section class="quick-actions" style="margin-top: 40px;">
                <a href="index.html" class="action-button">üìä View Dashboard</a>
                <a href="goals.html" class="action-button">üéØ Update Goals</a>
                <button class="action-button" onclick="downloadSample()">üìã Download Sample CSV</button>
                <button class="action-button" onclick="showSampleData()">üëÄ Show Sample Format</button>
            </section>

            <!-- Sample Data Display -->
            <div id="sampleDataDisplay" style="display: none;">
                <h3 style="color: white; margin: 20px 0 10px;">Sample CSV Format:</h3>
                <div class="sample-data">
Date,Amount,Description,Balance<br>
01/06/2025,-25.50,"COUNTDOWN CHRISTCHURCH",1234.50<br>
02/06/2025,2500.00,"PATHWAY ENGINEER SALARY",3734.00<br>
03/06/2025,-80.00,"Z ENERGY CHRISTCHURCH",3654.00<br>
04/06/2025,-120.00,"NEW WORLD GROCERY",3534.00<br>
05/06/2025,-15.00,"CAFE COFFEE",3519.00
                </div>
            </div>
        </div>
    </main>

    <script>
        let selectedFiles = [];
        let isAuthenticated = false;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            setupFileUpload();
            setupPrivacyMode();
            console.log('CSV Upload page initialized');
        });

        // Simple auth check
        function checkAuth() {
            const token = localStorage.getItem('financeos-token');
            if (!token) {
                window.location.href = 'index.html';
                return;
            }
            isAuthenticated = true;
            console.log('User authenticated');
        }

        function logout() {
            localStorage.removeItem('financeos-token');
            localStorage.removeItem('financeos-last-activity');
            window.location.href = 'index.html';
        }

        // File Upload Setup
        function setupFileUpload() {
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');

            console.log('Setting up file upload...');
            console.log('Upload zone:', uploadZone);
            console.log('File input:', fileInput);

            // File input change event - MOST IMPORTANT
            fileInput.addEventListener('change', function(e) {
                console.log('File input changed!', e.target.files);
                handleFileSelect(e);
            });

            // Click event on upload zone
            uploadZone.addEventListener('click', function(e) {
                console.log('Upload zone clicked');
                e.preventDefault();
                triggerFileInput();
            });

            // Drag and drop events
            uploadZone.addEventListener('dragover', handleDragOver);
            uploadZone.addEventListener('dragleave', handleDragLeave);
            uploadZone.addEventListener('drop', handleDrop);

            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            console.log('File upload setup complete');
        }

        function triggerFileInput() {
            console.log('Triggering file input...');
            const fileInput = document.getElementById('fileInput');
            fileInput.click();
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDragOver(e) {
            e.preventDefault();
            console.log('Drag over');
            document.getElementById('uploadZone').classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            console.log('Drag leave');
            document.getElementById('uploadZone').classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            console.log('Files dropped!', e.dataTransfer.files);
            document.getElementById('uploadZone').classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files);
            addFiles(files);
        }

        function handleFileSelect(e) {
            console.log('Files selected:', e.target.files);
            const files = Array.from(e.target.files);
            addFiles(files);
        }

        function addFiles(files) {
            console.log('Adding files:', files);
            
            if (files.length === 0) {
                console.log('No files to add');
                return;
            }

            const validFiles = files.filter(file => {
                const isValidType = file.name.toLowerCase().match(/\.(csv|xlsx|xls)$/);
                const isValidSize = file.size <= 10 * 1024 * 1024; // 10MB limit
                
                if (!isValidType) {
                    alert(`Invalid file type: ${file.name}. Please use CSV or Excel files.`);
                    return false;
                }
                
                if (!isValidSize) {
                    alert(`File too large: ${file.name}. Maximum size is 10MB.`);
                    return false;
                }
                
                return true;
            });

            console.log('Valid files:', validFiles);

            if (validFiles.length === 0) return;

            // Add to selected files
            validFiles.forEach(file => {
                const existingIndex = selectedFiles.findIndex(f => f.name === file.name);
                if (existingIndex === -1) {
                    selectedFiles.push({
                        file: file,
                        id: Date.now() + Math.random(),
                        status: 'ready'
                    });
                }
            });

            console.log('Selected files:', selectedFiles);
            displayFiles();
        }

        function displayFiles() {
            const filePreview = document.getElementById('filePreview');
            const fileList = document.getElementById('fileList');

            console.log('Displaying files:', selectedFiles);

            if (selectedFiles.length === 0) {
                filePreview.classList.remove('show');
                return;
            }

            filePreview.classList.add('show');
            fileList.innerHTML = '';

            selectedFiles.forEach((fileObj, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${fileObj.file.name}</div>
                        <div class="file-size">${formatFileSize(fileObj.file.size)}</div>
                    </div>
                    <div class="file-status status-${fileObj.status}" id="status-${fileObj.id}">
                        ${getStatusText(fileObj.status)}
                    </div>
                    <button class="remove-file" onclick="removeFile(${index})">Remove</button>
                `;
                fileList.appendChild(fileItem);
            });
        }

        function removeFile(index) {
            console.log('Removing file at index:', index);
            selectedFiles.splice(index, 1);
            displayFiles();
            
            // Clear the file input
            document.getElementById('fileInput').value = '';
        }

        function clearAllFiles() {
            console.log('Clearing all files');
            selectedFiles = [];
            displayFiles();
            document.getElementById('fileInput').value = '';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getStatusText(status) {
            switch (status) {
                case 'ready': return 'Ready';
                case 'processing': return 'Processing...';
                case 'success': return 'Success';
                case 'error': return 'Error';
                default: return 'Unknown';
            }
        }

        // File Processing
        function processFiles() {
            console.log('Processing files:', selectedFiles);
            
            if (selectedFiles.length === 0) {
                alert('Please select files to process');
                return;
            }

            const processButton = document.getElementById('processButton');
            const processingStatus = document.getElementById('processingStatus');
            
            processButton.disabled = true;
            processButton.textContent = '‚ö° Processing...';
            processingStatus.style.display = 'block';

            let processedCount = 0;
            let successCount = 0;
            let totalTransactions = 0;

            selectedFiles.forEach((fileObj, index) => {
                // Update status to processing
                fileObj.status = 'processing';
                updateFileStatus(fileObj.id, 'processing');

                // Simulate file processing with actual file reading
                setTimeout(() => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            const content = e.target.result;
                            console.log('File content loaded:', content.substring(0, 200));
                            
                            // Simple CSV parsing simulation
                            const lines = content.split('\n').filter(line => line.trim());
                            const transactionCount = Math.max(0, lines.length - 1); // Minus header
                            
                            console.log(`Processed ${fileObj.file.name}: ${transactionCount} transactions`);
                            
                            // Mark as success
                            fileObj.status = 'success';
                            fileObj.transactionCount = transactionCount;
                            updateFileStatus(fileObj.id, 'success', `${transactionCount} transactions`);
                            
                            successCount++;
                            totalTransactions += transactionCount;
                            
                        } catch (error) {
                            console.error('Processing error:', error);
                            fileObj.status = 'error';
                            updateFileStatus(fileObj.id, 'error', 'Failed to process');
                        }
                        
                        processedCount++;
                        
                        // All files processed
                        if (processedCount === selectedFiles.length) {
                            finishProcessing(successCount, totalTransactions);
                        }
                    };
                    
                    reader.onerror = function() {
                        console.error('Failed to read file:', fileObj.file.name);
                        fileObj.status = 'error';
                        updateFileStatus(fileObj.id, 'error', 'Failed to read');
                        processedCount++;
                        
                        if (processedCount === selectedFiles.length) {
                            finishProcessing(successCount, totalTransactions);
                        }
                    };
                    
                    reader.readAsText(fileObj.file);
                    
                }, 1000 + (index * 500)); // Stagger processing
            });
        }

        function updateFileStatus(fileId, status, extraText = '') {
            const statusElement = document.getElementById(`status-${fileId}`);
            if (statusElement) {
                statusElement.className = `file-status status-${status}`;
                statusElement.textContent = extraText || getStatusText(status);
            }
        }

        function finishProcessing(successCount, totalTransactions) {
            console.log('Processing finished:', { successCount, totalTransactions });
            
            const processButton = document.getElementById('processButton');
            const processingStatus = document.getElementById('processingStatus');
            
            processButton.disabled = false;
            processButton.textContent = '‚ö° Process Files';
            processingStatus.style.display = 'none';

            // Show results
            showResults(successCount === selectedFiles.length, successCount, totalTransactions);

            // Save data for demo
            if (successCount > 0) {
                saveProcessedData(totalTransactions);
            }
        }

        function showResults(allSuccess, successCount, totalTransactions) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsTitle = document.getElementById('resultsTitle');
            const resultsContent = document.getElementById('resultsContent');

            resultsSection.style.display = 'block';
            
            if (allSuccess) {
                resultsSection.className = 'results-section success';
                resultsTitle.innerHTML = '‚úÖ Upload Successful!';
                resultsContent.innerHTML = `
                    <p style="color: #34d399; font-size: 18px; margin-bottom: 15px;">
                        Successfully processed ${totalTransactions} transactions from ${successCount} file(s).
                    </p>
                    <p style="color: rgba(255, 255, 255, 0.8);">
                        Your transactions have been automatically categorized and added to your financial data.
                        <a href="index.html" style="color: #60a5fa; text-decoration: none;">View Dashboard ‚Üí</a>
                    </p>
                `;
            } else {
                resultsSection.className = 'results-section error';
                resultsTitle.innerHTML = '‚ö†Ô∏è Some Files Failed';
                resultsContent.innerHTML = `
                    <p style="color: #f87171; font-size: 18px; margin-bottom: 15px;">
                        ${successCount} of ${selectedFiles.length} files processed successfully.
                    </p>
                    <p style="color: rgba(255, 255, 255, 0.8);">
                        Please check the file format and try again for failed files.
                    </p>
                `;
            }
        }

        function saveProcessedData(transactionCount) {
            console.log('Saving processed data:', transactionCount);
            
            // Save demo data
            const existingData = JSON.parse(localStorage.getItem('csvData') || '[]');
            const newData = Array.from({length: transactionCount}, (_, i) => ({
                id: Date.now() + i,
                date: new Date().toISOString().split('T')[0],
                amount: (Math.random() * 400 - 200).toFixed(2),
                description: `Transaction ${i + 1}`,
                category: ['Groceries', 'Fuel', 'Dining', 'Shopping', 'Bills'][Math.floor(Math.random() * 5)]
            }));
            
            localStorage.setItem('csvData', JSON.stringify([...existingData, ...newData]));
            localStorage.setItem('csvUploadDate', new Date().toISOString());
            
            console.log('Data saved to localStorage');
        }

        // Utility Functions
        function downloadSample() {
            const sampleData = `Date,Amount,Description,Balance
01/06/2025,-25.50,"COUNTDOWN CHRISTCHURCH",1234.50
02/06/2025,2500.00,"PATHWAY ENGINEER SALARY",3734.00
03/06/2025,-80.00,"Z ENERGY CHRISTCHURCH",3654.00
04/06/2025,-120.00,"NEW WORLD GROCERY",3534.00
05/06/2025,-15.00,"CAFE COFFEE",3519.00`;

            const blob = new Blob([sampleData], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sample-bank-statement.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function showSampleData() {
            const sampleDisplay = document.getElementById('sampleDataDisplay');
            sampleDisplay.style.display = sampleDisplay.style.display === 'none' ? 'block' : 'none';
        }

        function setupPrivacyMode() {
            const privacyToggle = document.getElementById('privacyToggle');
            let privacyMode = localStorage.getItem('privacyMode') === 'true';
            
            updatePrivacyMode();

            privacyToggle?.addEventListener('click', () => {
                privacyMode = !privacyMode;
                localStorage.setItem('privacyMode', privacyMode);
                updatePrivacyMode();
            });

            function updatePrivacyMode() {
                if (privacyMode) {
                    document.body.classList.add('privacy-mode');
                    if (privacyToggle) {
                        privacyToggle.textContent = 'üîì Show Data';
                        privacyToggle.classList.add('active');
                    }
                } else {
                    document.body.classList.remove('privacy-mode');
                    if (privacyToggle) {
                        privacyToggle.textContent = 'üîí Privacy Mode';
                        privacyToggle.classList.remove('active');
                    }
                }
            }
        }

        console.log('FinanceOS CSV Upload page loaded successfully');
    </script>
</body>
</html>