<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceOS - Upload CSV</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#8b5cf6">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 25%, #312e81 50%, #1e1b4b 75%, #0f172a 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        /* Glass Effects */
        .glass {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .glass-premium {
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.15) 0%, 
                rgba(59, 130, 246, 0.15) 50%, 
                rgba(147, 51, 234, 0.15) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        /* Header */
        .header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: bold;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #8b5cf6, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Navigation */
        .nav {
            display: flex;
            gap: 1rem;
        }

        .nav-button {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .nav-button.active {
            background: linear-gradient(135deg, #8b5cf6, #9333ea);
            border-color: rgba(139, 92, 246, 0.5);
        }

        /* Privacy Toggle */
        .privacy-toggle {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .privacy-toggle:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .privacy-toggle.active {
            background: rgba(16, 185, 129, 0.2);
            border-color: rgba(16, 185, 129, 0.4);
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #8b5cf6, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-subtitle {
            font-size: 1.125rem;
            opacity: 0.8;
            margin-bottom: 2rem;
        }

        /* Upload Area */
        .upload-section {
            margin-bottom: 2rem;
        }

        .upload-area {
            border: 2px dashed rgba(139, 92, 246, 0.5);
            border-radius: 16px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 2rem;
        }

        .upload-area:hover {
            border-color: rgba(139, 92, 246, 0.8);
            background: rgba(139, 92, 246, 0.05);
        }

        .upload-area.dragover {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.7;
        }

        .upload-text {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            opacity: 0.7;
            margin-bottom: 1.5rem;
        }

        .file-input {
            display: none;
        }

        .upload-button {
            background: linear-gradient(135deg, #8b5cf6, #9333ea);
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 24px rgba(139, 92, 246, 0.4);
        }

        /* Bank Format Guide */
        .format-guide {
            margin-bottom: 2rem;
        }

        .format-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }

        .format-card {
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid;
        }

        .format-card h4 {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .format-card ul {
            list-style: none;
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .format-card li {
            margin-bottom: 0.25rem;
        }

        /* Processing Status */
        .processing-status {
            display: none;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .processing-status.show {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #8b5cf6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Results */
        .results-section {
            display: none;
        }

        .results-section.show {
            display: block;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .result-card {
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .result-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .result-label {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        /* Transaction Preview */
        .transaction-preview {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .transaction-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 600;
            position: sticky;
            top: 0;
            backdrop-filter: blur(20px);
        }

        .transaction-row {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr 1fr;
            gap: 1rem;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            align-items: center;
        }

        .transaction-amount {
            font-weight: 600;
        }

        .positive {
            color: #10b981;
        }

        .negative {
            color: #ef4444;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6, #9333ea);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .nav {
                flex-wrap: wrap;
                justify-content: center;
            }

            .upload-area {
                padding: 2rem 1rem;
            }

            .format-grid {
                grid-template-columns: 1fr;
            }

            .transaction-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header glass">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">$</div>
                <span class="logo-text">FinanceOS</span>
            </div>
            
            <nav class="nav">
                <a href="index.html" class="nav-button">Dashboard</a>
                <a href="csv-upload.html" class="nav-button active">Upload CSV</a>
                <a href="goals.html" class="nav-button">Goals</a>
                <button class="privacy-toggle" id="privacyToggle">ðŸ”’ Privacy Mode</button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <h1 class="page-title">Upload Bank Statements</h1>
        <p class="page-subtitle">
            Upload your weekly CSV bank statements to automatically process transactions and update your financial data across all pages.
        </p>

        <!-- Upload Section -->
        <section class="upload-section">
            <div class="upload-area glass-premium" id="uploadArea">
                <div class="upload-icon">ðŸ“¤</div>
                <div class="upload-text">Drag & Drop CSV Files Here</div>
                <div class="upload-subtext">or click to browse your computer</div>
                <button class="upload-button" onclick="document.getElementById('fileInput').click()">
                    Choose Files
                </button>
                <input type="file" id="fileInput" class="file-input" multiple accept=".csv,.xls,.xlsx">
            </div>
        </section>

        <!-- Bank Format Guide -->
        <section class="format-guide">
            <h2 class="section-title" style="margin-bottom: 1rem;">Supported Bank Formats</h2>
            <div class="format-grid">
                <div class="format-card glass" style="border-left-color: #3b82f6;">
                    <h4>ANZ Bank</h4>
                    <ul>
                        <li>â€¢ Date, Amount, Description, Balance</li>
                        <li>â€¢ Standard ANZ CSV export format</li>
                        <li>â€¢ Automatically detects format</li>
                    </ul>
                </div>
                
                <div class="format-card glass" style="border-left-color: #10b981;">
                    <h4>ASB Bank</h4>
                    <ul>
                        <li>â€¢ Date, Unique Id, Amount, Payee</li>
                        <li>â€¢ Includes transaction type</li>
                        <li>â€¢ Memo field supported</li>
                    </ul>
                </div>
                
                <div class="format-card glass" style="border-left-color: #8b5cf6;">
                    <h4>BNZ Bank</h4>
                    <ul>
                        <li>â€¢ Date, Amount, Payee, Description</li>
                        <li>â€¢ Reference fields included</li>
                        <li>â€¢ Transaction type classification</li>
                    </ul>
                </div>
                
                <div class="format-card glass" style="border-left-color: #f59e0b;">
                    <h4>Kiwibank</h4>
                    <ul>
                        <li>â€¢ Date, Memo/Description, Amount</li>
                        <li>â€¢ Balance information included</li>
                        <li>â€¢ Simple format structure</li>
                    </ul>
                </div>
                
                <div class="format-card glass" style="border-left-color: #ef4444;">
                    <h4>Westpac</h4>
                    <ul>
                        <li>â€¢ Comprehensive field set</li>
                        <li>â€¢ Particulars, Code, Reference</li>
                        <li>â€¢ Other Party information</li>
                    </ul>
                </div>
                
                <div class="format-card glass" style="border-left-color: #6366f1;">
                    <h4>Generic CSV</h4>
                    <ul>
                        <li>â€¢ Custom mapping available</li>
                        <li>â€¢ Date, Amount, Description minimum</li>
                        <li>â€¢ Auto-detection fallback</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Processing Status -->
        <section class="processing-status glass-premium" id="processingStatus">
            <div class="spinner"></div>
            <h3>Processing Your Bank Statements...</h3>
            <p>Analyzing transactions, detecting duplicates, and categorizing expenses.</p>
        </section>

        <!-- Results Section -->
        <section class="results-section" id="resultsSection">
            <h2 class="section-title" style="margin-bottom: 1rem;">Processing Results</h2>
            
            <div class="results-grid">
                <div class="result-card glass-premium">
                    <div class="result-number positive" id="newTransactions">0</div>
                    <div class="result-label">New Transactions</div>
                </div>
                
                <div class="result-card glass">
                    <div class="result-number" style="color: #f59e0b;" id="duplicatesFound">0</div>
                    <div class="result-label">Duplicates Skipped</div>
                </div>
                
                <div class="result-card glass">
                    <div class="result-number" style="color: #8b5cf6;" id="categorized">0</div>
                    <div class="result-label">Auto-Categorized</div>
                </div>
                
                <div class="result-card glass">
                    <div class="result-number" style="color: #3b82f6;" id="dateRange">-</div>
                    <div class="result-label">Date Range</div>
                </div>
            </div>

            <!-- Transaction Preview -->
            <div class="transaction-preview glass" id="transactionPreview">
                <div class="transaction-header">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 2fr 1fr; gap: 1rem;">
                        <div>Date</div>
                        <div>Amount</div>
                        <div>Description</div>
                        <div>Category</div>
                    </div>
                </div>
                <div id="transactionList">
                    <!-- Transactions will be populated here -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-primary" id="saveData">Save to Dashboard</button>
                <button class="btn btn-secondary" id="exportData">Export Processed Data</button>
                <a href="index.html" class="btn btn-secondary">View Dashboard</a>
            </div>
        </section>
    </main>

    <script>
        // Privacy Mode Toggle
        const privacyToggle = document.getElementById('privacyToggle');
        const mainContent = document.getElementById('mainContent');
        
        let privacyMode = localStorage.getItem('privacyMode') === 'true';
        updatePrivacyMode();

        privacyToggle.addEventListener('click', () => {
            privacyMode = !privacyMode;
            localStorage.setItem('privacyMode', privacyMode);
            updatePrivacyMode();
        });

        function updatePrivacyMode() {
            if (privacyMode) {
                mainContent.classList.add('privacy-mode');
                privacyToggle.textContent = 'ðŸ”“ Show Data';
                privacyToggle.classList.add('active');
            } else {
                mainContent.classList.remove('privacy-mode');
                privacyToggle.textContent = 'ðŸ”’ Privacy Mode';
                privacyToggle.classList.remove('active');
            }
        }

        // File Upload Handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const processingStatus = document.getElementById('processingStatus');
        const resultsSection = document.getElementById('resultsSection');

        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // File processing
        function handleFiles(files) {
            if (files.length === 0) return;

            processingStatus.classList.add('show');
            resultsSection.classList.remove('show');

            // Simulate processing delay
            setTimeout(() => {
                processCSVFiles(files);
            }, 2000);
        }

        function processCSVFiles(files) {
            let allTransactions = [];
            let duplicateCount = 0;
            let processedFiles = 0;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    const transactions = parseCSV(content, file.name);
                    
                    // Simulate duplicate detection
                    const existingData = JSON.parse(localStorage.getItem('csvData') || '[]');
                    const newTransactions = transactions.filter(t => 
                        !existingData.some(existing => 
                            existing.date === t.date && 
                            existing.amount === t.amount && 
                            existing.description === t.description
                        )
                    );
                    
                    duplicateCount += transactions.length - newTransactions.length;
                    allTransactions = [...allTransactions, ...newTransactions];
                    
                    processedFiles++;
                    if (processedFiles === files.length) {
                        showResults(allTransactions, duplicateCount);
                    }
                };
                reader.readAsText(file);
            });
        }

        function parseCSV(content, filename) {
            const lines = content.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            // Detect bank format
            const bankFormat = detectBankFormat(headers);
            
            const transactions = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length >= 3) {
                    const transaction = mapToStandardFormat(values, headers, bankFormat);
                    if (transaction) {
                        transactions.push(transaction);
                    }
                }
            }
            
            return transactions;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            
            return result;
        }

        function detectBankFormat(headers) {
            const headerStr = headers.join(',').toLowerCase();
            
            if (headerStr.includes('unique id') || headerStr.includes('tran type')) {
                return 'ASB';
            } else if (headerStr.includes('other party') || headerStr.includes('particulars')) {
                return 'WESTPAC';
            } else if (headerStr.includes('memo') && headerStr.includes('balance')) {
                return 'KIWIBANK';
            } else if (headerStr.includes('payee') && headerStr.includes('reference')) {
                return 'BNZ';
            } else if (headerStr.includes('description') && headerStr.includes('balance')) {
                return 'ANZ';
            }
            return 'GENERIC';
        }

        function mapToStandardFormat(values, headers, bankFormat) {
            const transaction = {};
            
            // Basic mapping logic - this would be more sophisticated in real implementation
            const dateIndex = headers.findIndex(h => h.toLowerCase().includes('date'));
            const amountIndex = headers.findIndex(h => h.toLowerCase().includes('amount'));
            const descIndex = headers.findIndex(h => 
                h.toLowerCase().includes('description') || 
                h.toLowerCase().includes('memo') || 
                h.toLowerCase().includes('payee')
            );
            
            if (dateIndex >= 0 && amountIndex >= 0 && descIndex >= 0) {
                transaction.date = values[dateIndex] || '';
                transaction.amount = parseFloat(values[amountIndex]?.replace(/[^-\d.]/g, '') || '0');
                transaction.description = values[descIndex] || '';
                transaction.category = categorizeTransaction(transaction.description);
                transaction.bank = bankFormat;
                
                return transaction;
            }
            
            return null;
        }

        function categorizeTransaction(description) {
            const desc = description.toLowerCase();
            
            if (desc.includes('countdown') || desc.includes('pak n save') || desc.includes('new world')) {
                return 'Groceries';
            } else if (desc.includes('bp ') || desc.includes('z energy') || desc.includes('mobil')) {
                return 'Fuel';
            } else if (desc.includes('interest')) {
                return 'Income';
            } else if (desc.includes('fee')) {
                return 'Bank Fees';
            } else if (desc.includes('mortgage') || desc.includes('rent')) {
                return 'Housing';
            } else if (desc.includes('kfc') || desc.includes('mcdonald') || desc.includes('restaurant')) {
                return 'Dining Out';
            }
            
            return 'Uncategorized';
        }

        function showResults(transactions, duplicateCount) {
            processingStatus.classList.remove('show');
            resultsSection.classList.add('show');
            
            // Update result numbers
            document.getElementById('newTransactions').textContent = transactions.length;
            document.getElementById('duplicatesFound').textContent = duplicateCount;
            document.getElementById('categorized').textContent = transactions.filter(t => t.category !== 'Uncategorized').length;
            
            if (transactions.length > 0) {
                const dates = transactions.map(t => new Date(t.date)).sort();
                const startDate = dates[0].toLocaleDateString();
                const endDate = dates[dates.length - 1].toLocaleDateString();
                document.getElementById('dateRange').textContent = `${startDate} - ${endDate}`;
            }
            
            // Show transaction preview
            displayTransactionPreview(transactions.slice(0, 10)); // Show first 10
            
            // Store processed data
            window.processedTransactions = transactions;
        }

        function displayTransactionPreview(transactions) {
            const transactionList = document.getElementById('transactionList');
            transactionList.innerHTML = '';
            
            transactions.forEach(transaction => {
                const row = document.createElement('div');
                row.className = 'transaction-row';
                
                const amountClass = transaction.amount >= 0 ? 'positive' : 'negative';
                const formattedAmount = transaction.amount >= 0 ? 
                    `+$${transaction.amount.toFixed(2)}` : 
                    `-$${Math.abs(transaction.amount).toFixed(2)}`;
                
                row.innerHTML = `
                    <div>${transaction.date}</div>
                    <div class="transaction-amount ${amountClass}">${formattedAmount}</div>
                    <div>${transaction.description}</div>
                    <div>${transaction.category}</div>
                `;
                
                transactionList.appendChild(row);
            });
        }

        // Save data functionality
        document.getElementById('saveData').addEventListener('click', () => {
            if (window.processedTransactions) {
                // Merge with existing data
                const existingData = JSON.parse(localStorage.getItem('csvData') || '[]');
                const mergedData = [...existingData, ...window.processedTransactions];
                
                // Store in localStorage
                localStorage.setItem('csvData', JSON.stringify(mergedData));
                localStorage.setItem('csvUploadDate', new Date().toISOString());
                
                alert('Data saved successfully! You can now view it on the dashboard.');
                
                // Redirect to dashboard
                window.location.href = 'index.html';
            }
        });

        // Export data functionality
        document.getElementById('exportData').addEventListener('click', () => {
            if (window.processedTransactions) {
                const csv = convertToCSV(window.processedTransactions);
                downloadCSV(csv, 'processed-transactions.csv');
            }
        });

        function convertToCSV(data) {
            const headers = ['Date', 'Amount', 'Description', 'Category', 'Bank'];
            const csvContent = [
                headers.join(','),
                ...data.map(t => [
                    t.date,
                    t.amount,
                    `"${t.description}"`,
                    t.category,
                    t.bank
                ].join(','))
            ].join('\n');
            
            return csvContent;
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>
</html>