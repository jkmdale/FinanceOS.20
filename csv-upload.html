<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceOS - Upload CSV</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#8b5cf6">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header glass">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">$</div>
                <span class="logo-text">FinanceOS</span>
            </div>
            
            <nav class="nav">
                <a href="index.html" class="nav-button">Dashboard</a>
                <a href="csv-upload.html" class="nav-button active">Upload CSV</a>
                <a href="goals.html" class="nav-button">Goals</a>
                <button class="privacy-toggle" id="privacyToggle">ðŸ”’ Privacy Mode</button>
                <button class="nav-button" id="notificationSettings">ðŸ”” Notifications</button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <h1 class="page-title">Upload Bank Statements</h1>
        <p class="page-subtitle">
            Upload your weekly CSV bank statements to automatically process transactions and update your financial data across all pages.
        </p>

        <!-- Upload Section -->
        <section class="upload-section">
            <div class="upload-area glass-premium" id="uploadArea">
                <div class="upload-icon">ðŸ“¤</div>
                <div class="upload-text">Drag & Drop CSV Files Here</div>
                <div class="upload-subtext">or click to browse your computer</div>
                <button class="upload-button" onclick="document.getElementById('fileInput').click()">
                    Choose Files
                </button>
                <input type="file" id="fileInput" class="file-input" multiple accept=".csv,.xls,.xlsx">
            </div>
        </section>

        <!-- Bank Format Guide -->
        <section class="format-guide">
            <h2 class="section-title" style="margin-bottom: 1rem;">Supported Bank Formats</h2>
            <div class="format-grid">
                <div class="format-card glass" style="border-left-color: #3b82f6;">
                    <h4>ANZ Bank</h4>
                    <ul>
                        <li>â€¢ Date, Amount, Description, Balance</li>
                        <li>â€¢ Standard ANZ CSV export format</li>
                        <li>â€¢ Automatically detects format</li>
                    </ul>
                </div>
                
                <div class="format-card glass" style="border-left-color: #10b981;">
                    <h4>ASB Bank</h4>
                    <ul>
                        <li>â€¢ Date, Unique Id, Amount, Payee</li>
                        <li>â€¢ Includes transaction type</li>
                        <li>â€¢ Memo field supported</li>
                    </ul>
                </div>
                
                <div class="format-card glass" style="border-left-color: #8b5cf6;">
                    <h4>BNZ Bank</h4>
                    <ul>
                        <li>â€¢ Date, Amount, Payee, Description</li>
                        <li>â€¢ Reference fields included</li>
                        <li>â€¢ Transaction type classification</li>
                    </ul>
                </div>
                
                <div class="format-card glass" style="border-left-color: #f59e0b;">
                    <h4>Kiwibank</h4>
                    <ul>
                        <li>â€¢ Date, Memo/Description, Amount</li>
                        <li>â€¢ Balance information included</li>
                        <li>â€¢ Simple format structure</li>
                    </ul>
                </div>
                
                <div class="format-card glass" style="border-left-color: #ef4444;">
                    <h4>Westpac</h4>
                    <ul>
                        <li>â€¢ Comprehensive field set</li>
                        <li>â€¢ Particulars, Code, Reference</li>
                        <li>â€¢ Other Party information</li>
                    </ul>
                </div>
                
                <div class="format-card glass" style="border-left-color: #6366f1;">
                    <h4>Generic CSV</h4>
                    <ul>
                        <li>â€¢ Custom mapping available</li>
                        <li>â€¢ Date, Amount, Description minimum</li>
                        <li>â€¢ Auto-detection fallback</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Processing Status -->
        <section class="processing-status glass-premium" id="processingStatus">
            <div class="spinner"></div>
            <h3>Processing Your Bank Statements...</h3>
            <p>Analyzing transactions, detecting duplicates, and categorizing expenses.</p>
        </section>

        <!-- Results Section -->
        <section class="results-section" id="resultsSection">
            <h2 class="section-title" style="margin-bottom: 1rem;">Processing Results</h2>
            
            <div class="results-grid">
                <div class="result-card glass-premium">
                    <div class="result-number positive" id="newTransactions">0</div>
                    <div class="result-label">New Transactions</div>
                </div>
                
                <div class="result-card glass">
                    <div class="result-number" style="color: #f59e0b;" id="duplicatesFound">0</div>
                    <div class="result-label">Duplicates Skipped</div>
                </div>
                
                <div class="result-card glass">
                    <div class="result-number" style="color: #8b5cf6;" id="categorized">0</div>
                    <div class="result-label">Auto-Categorized</div>
                </div>
                
                <div class="result-card glass">
                    <div class="result-number" style="color: #3b82f6;" id="dateRange">-</div>
                    <div class="result-label">Date Range</div>
                </div>
            </div>

            <!-- Transaction Preview -->
            <div class="transaction-preview glass" id="transactionPreview">
                <div class="transaction-header">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 2fr 1fr; gap: 1rem;">
                        <div>Date</div>
                        <div>Amount</div>
                        <div>Description</div>
                        <div>Category</div>
                    </div>
                </div>
                <div id="transactionList">
                    <!-- Transactions will be populated here -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-primary" id="saveData">Save to Dashboard</button>
                <button class="btn btn-secondary" id="exportData">Export Processed Data</button>
                <a href="index.html" class="btn btn-secondary">View Dashboard</a>
            </div>
        </section>
    </main>

    <script src="data-manager.js"></script>
    <script src="notification-system.js"></script>
    <script>
        // Privacy Mode Toggle
        const privacyToggle = document.getElementById('privacyToggle');
        const mainContent = document.getElementById('mainContent');
        
        let privacyMode = localStorage.getItem('privacyMode') === 'true';
        updatePrivacyMode();

        privacyToggle.addEventListener('click', () => {
            privacyMode = !privacyMode;
            localStorage.setItem('privacyMode', privacyMode);
            updatePrivacyMode();
        });

        function updatePrivacyMode() {
            if (privacyMode) {
                mainContent.classList.add('privacy-mode');
                privacyToggle.textContent = 'ðŸ”“ Show Data';
                privacyToggle.classList.add('active');
            } else {
                mainContent.classList.remove('privacy-mode');
                privacyToggle.textContent = 'ðŸ”’ Privacy Mode';
                privacyToggle.classList.remove('active');
            }
        }

        // File Upload Handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const processingStatus = document.getElementById('processingStatus');
        const resultsSection = document.getElementById('resultsSection');

        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // File processing
        function handleFiles(files) {
            if (files.length === 0) return;

            processingStatus.classList.add('show');
            resultsSection.classList.remove('show');

            // Use FinanceOS Data Manager if available
            if (window.FinanceOSData) {
                window.FinanceOSData.processCSVFiles(files)
                    .then(results => {
                        showResults(results.newTransactions, results.summary.duplicates);
                    })
                    .catch(error => {
                        console.error('CSV processing error:', error);
                        alert('Error processing CSV files. Please check the format and try again.');
                        processingStatus.classList.remove('show');
                    });
            } else {
                // Fallback processing
                setTimeout(() => {
                    processCSVFilesFallback(files);
                }, 2000);
            }
        }

        // Fallback CSV processing if data manager not available
        function processCSVFilesFallback(files) {
            let allTransactions = [];
            let duplicateCount = 0;
            let processedFiles = 0;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    const transactions = parseCSVFallback(content, file.name);
                    
                    // Simple duplicate detection
                    const existingData = JSON.parse(localStorage.getItem('csvData') || '[]');
                    const newTransactions = transactions.filter(t => 
                        !existingData.some(existing => 
                            existing.date === t.date && 
                            existing.amount === t.amount && 
                            existing.description === t.description
                        )
                    );
                    
                    duplicateCount += transactions.length - newTransactions.length;
                    allTransactions = [...allTransactions, ...newTransactions];
                    
                    processedFiles++;
                    if (processedFiles === files.length) {
                        showResults(allTransactions, duplicateCount);
                    }
                };
                reader.readAsText(file);
            });
        }

        function parseCSVFallback(content, filename) {
            const lines = content.split('\n').filter(line => line.trim());
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            const transactions = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length >= 3) {
                    const transaction = mapToStandardFormat(values, headers, filename);
                    if (transaction) {
                        transactions.push(transaction);
                    }
                }
            }
            
            return transactions;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim().replace(/^"|"$/g, ''));
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim().replace(/^"|"$/g, ''));
            return result;
        }

        function mapToStandardFormat(values, headers, filename) {
            const transaction = {
                id: 'txn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                date: null,
                amount: 0,
                description: '',
                category: 'Uncategorized',
                sourceFile: filename
            };

            // Map common field positions
            const dateIndex = headers.findIndex(h => h.toLowerCase().includes('date'));
            const amountIndex = headers.findIndex(h => h.toLowerCase().includes('amount'));
            const descIndex = headers.findIndex(h => 
                h.toLowerCase().includes('description') || 
                h.toLowerCase().includes('memo') || 
                h.toLowerCase().includes('payee') ||
                h.toLowerCase().includes('particulars')
            );

            if (dateIndex >= 0 && values[dateIndex]) {
                transaction.date = parseDate(values[dateIndex]);
            }
            
            if (amountIndex >= 0 && values[amountIndex]) {
                transaction.amount = parseAmount(values[amountIndex]);
            }
            
            if (descIndex >= 0 && values[descIndex]) {
                transaction.description = values[descIndex];
                transaction.category = categorizeTransaction(values[descIndex]);
            }

            // Only return transaction if we have essential data
            if (transaction.date && transaction.description) {
                return transaction;
            }
            
            return null;
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            // Try different date formats
            const formats = [
                /(\d{1,2})\/(\d{1,2})\/(\d{4})/,     // DD/MM/YYYY
                /(\d{4})-(\d{1,2})-(\d{1,2})/,       // YYYY-MM-DD
                /(\d{1,2})-(\d{1,2})-(\d{4})/        // DD-MM-YYYY
            ];

            for (const format of formats) {
                const match = dateStr.match(format);
                if (match) {
                    let day, month, year;
                    
                    if (format === formats[1]) { // YYYY-MM-DD
                        [, year, month, day] = match;
                    } else { // DD/MM/YYYY, DD-MM-YYYY
                        [, day, month, year] = match;
                    }
                    
                    const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                    if (!isNaN(date.getTime())) {
                        return date.toISOString().split('T')[0];
                    }
                }
            }

            return new Date().toISOString().split('T')[0]; // Fallback to today
        }

        function parseAmount(amountStr) {
            if (!amountStr) return 0;
            
            // Clean and parse amount
            let cleanAmount = amountStr.toString()
                .replace(/[$,\s]/g, '')
                .replace(/[()]/g, '')
                .trim();
            
            const isNegative = amountStr.includes('(') || amountStr.includes('-') || 
                              amountStr.toLowerCase().includes('dr');
            
            const numericMatch = cleanAmount.match(/\d+\.?\d*/);
            if (!numericMatch) return 0;
            
            let amount = parseFloat(numericMatch[0]);
            return isNegative ? -Math.abs(amount) : amount;
        }

        function categorizeTransaction(description) {
            if (!description) return 'Uncategorized';
            
            const desc = description.toLowerCase();
            
            // NZ-specific categorization
            if (desc.includes('countdown') || desc.includes('pak n save') || desc.includes('new world') || desc.includes('fresh choice')) {
                return 'Groceries';
            } else if (desc.includes('bp ') || desc.includes('z energy') || desc.includes('mobil') || desc.includes('gull')) {
                return 'Fuel';
            } else if (desc.includes('eftpos') || desc.includes('atm')) {
                return 'Cash Withdrawal';
            } else if (desc.includes('interest')) {
                return 'Income';
            } else if (desc.includes('fee')) {
                return 'Bank Fees';
            } else if (desc.includes('mortgage') || desc.includes('rent')) {
                return 'Housing';
            } else if (desc.includes('mcdonald') || desc.includes('kfc') || desc.includes('burger') || desc.includes('pizza')) {
                return 'Dining Out';
            } else if (desc.includes('spark') || desc.includes('vodafone') || desc.includes('2degrees') || desc.includes('sky')) {
                return 'Utilities';
            }
            
            return 'Uncategorized';
        }

        function showResults(transactions, duplicateCount) {
            processingStatus.classList.remove('show');
            resultsSection.classList.add('show');
            
            // Update result numbers
            document.getElementById('newTransactions').textContent = transactions.length;
            document.getElementById('duplicatesFound').textContent = duplicateCount;
            document.getElementById('categorized').textContent = transactions.filter(t => t.category !== 'Uncategorized').length;
            
            if (transactions.length > 0) {
                const dates = transactions.map(t => new Date(t.date)).sort();
                const startDate = dates[0].toLocaleDateString();
                const endDate = dates[dates.length - 1].toLocaleDateString();
                document.getElementById('dateRange').textContent = `${startDate} - ${endDate}`;
            }
            
            // Show transaction preview
            displayTransactionPreview(transactions.slice(0, 10));
            
            // Store processed data
            window.processedTransactions = transactions;
        }

        function displayTransactionPreview(transactions) {
            const transactionList = document.getElementById('transactionList');
            transactionList.innerHTML = '';
            
            transactions.forEach(transaction => {
                const row = document.createElement('div');
                row.className = 'transaction-row';
                
                const amountClass = transaction.amount >= 0 ? 'positive' : 'negative';
                const formattedAmount = transaction.amount >= 0 ? 
                    `+$${transaction.amount.toFixed(2)}` : 
                    `-$${Math.abs(transaction.amount).toFixed(2)}`;
                
                row.innerHTML = `
                    <div>${transaction.date}</div>
                    <div class="transaction-amount ${amountClass}">${formattedAmount}</div>
                    <div>${transaction.description}</div>
                    <div>${transaction.category}</div>
                `;
                
                transactionList.appendChild(row);
            });
        }

        // Save data functionality
        document.getElementById('saveData').addEventListener('click', () => {
            if (window.processedTransactions) {
                // Merge with existing data
                const existingData = JSON.parse(localStorage.getItem('csvData') || '[]');
                const mergedData = [...existingData, ...window.processedTransactions];
                
                // Store in localStorage
                localStorage.setItem('csvData', JSON.stringify(mergedData));
                localStorage.setItem('csvUploadDate', new Date().toISOString());
                
                // Trigger CSV upload event for notifications
                if (window.FinanceOSNotifications) {
                    window.dispatchEvent(new CustomEvent('csvUploadSuccess'));
                }
                
                alert('Data saved successfully! You can now view it on the dashboard.');
                
                // Redirect to dashboard
                window.location.href = 'index.html';
            }
        });

        // Export data functionality
        document.getElementById('exportData').addEventListener('click', () => {
            if (window.processedTransactions) {
                const csv = convertToCSV(window.processedTransactions);
                downloadCSV(csv, 'processed-transactions.csv');
            }
        });

        function convertToCSV(data) {
            const headers = ['Date', 'Amount', 'Description', 'Category', 'Source File'];
            const csvContent = [
                headers.join(','),
                ...data.map(t => [
                    t.date,
                    t.amount,
                    `"${t.description}"`,
                    t.category,
                    t.sourceFile || ''
                ].join(','))
            ].join('\n');
            
            return csvContent;
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Notification Settings
        document.getElementById('notificationSettings').addEventListener('click', () => {
            if (window.FinanceOSNotifications) {
                window.FinanceOSNotifications.showNotificationSettings();
            } else {
                alert('Notification system will be available once notifications.js is loaded');
            }
        });

        // Initialize
        if (window.FinanceOSHelpers) {
            window.FinanceOSHelpers.initializePage();
        }

        console.log('FinanceOS CSV Upload loaded successfully - No authentication required');
    </script>

    <style>
        /* Additional styles for upload functionality */
        .upload-section {
            margin-bottom: 2rem;
        }

        .upload-area {
            border: 2px dashed rgba(139, 92, 246, 0.5);
            border-radius: 16px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 2rem;
        }

        .upload-area:hover {
            border-color: rgba(139, 92, 246, 0.8);
            background: rgba(139, 92, 246, 0.05);
        }

        .upload-area.dragover {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.7;
        }

        .upload-text {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            opacity: 0.7;
            margin-bottom: 1.5rem;
        }

        .file-input {
            display: none;
        }

        .upload-button {
            background: linear-gradient(135deg, #8b5cf6, #9333ea);
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 24px rgba(139, 92, 246, 0.4);
        }

        .format-guide {
            margin-bottom: 2rem;
        }

        .format-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }

        .format-card {
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid;
        }

        .format-card h4 {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .format-card ul {
            list-style: none;
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .format-card li {
            margin-bottom: 0.25rem;
        }

        .processing-status {
            display: none;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .processing-status.show {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #8b5cf6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            display: none;
        }

        .results-section.show {
            display: block;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .result-card {
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .result-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .result-label {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .transaction-preview {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .transaction-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 600;
            position: sticky;
            top: 0;
            backdrop-filter: blur(20px);
        }

        .transaction-row {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr 1fr;
            gap: 1rem;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            align-items: center;
        }

        .transaction-amount {
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        @media (max-width: 768px) {
            .upload-area {
                padding: 2rem 1rem;
            }

            .format-grid {
                grid-template-columns: 1fr;
            }

            .transaction-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</body>
</html>