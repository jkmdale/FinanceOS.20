<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceOS - Upload CSV</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#8b5cf6">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header glass">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">$</div>
                <span class="logo-text">FinanceOS</span>
            </div>
            
            <nav class="nav">
                <a href="index.html" class="nav-button">Dashboard</a>
                <a href="csv-upload.html" class="nav-button active">Upload CSV</a>
                <a href="goals.html" class="nav-button">Goals</a>
                <button class="privacy-toggle" id="privacyToggle">ðŸ”’ Privacy Mode</button>
                <button class="nav-button" id="notificationSettings">ðŸ”” Notifications</button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <h1 class="page-title">Upload Bank Statements</h1>
        <p class="page-subtitle">
            Upload your weekly CSV bank statements to automatically process transactions and update your financial data across all pages.
        </p>

        <!-- Upload Section -->
        <section class="upload-section">
            <div class="upload-area glass-premium" id="uploadArea">
                <div class="upload-icon">ðŸ“¤</div>
                <div class="upload-text">Drag & Drop CSV Files Here</div>
                <div class="upload-subtext">or click to browse your computer</div>
                <button class="upload-button" onclick="document.getElementById('fileInput').click()">
                    Choose Files
                </button>
                <input type="file" id="fileInput" class="file-input" multiple accept=".csv,.xls,.xlsx">
            </div>
        </section>

        <!-- Bank Format Guide -->
        <section class="format-guide">
            <h2 class="section-title" style="margin-bottom: 1rem;">Supported Bank Formats</h2>
            <div class="format-grid">
                <div class="format-card glass" style="border-left-color: #3b82f6;">
                    <h4>ANZ Bank</h4>
                    <ul>
                        <li>â€¢ Date, Amount, Description, Balance</li>
                        <li>â€¢ Standard ANZ CSV export format</li>
                        <li>â€¢ Automatically detects format</li>
                    </ul>
                </div>
                
                <div class="format-card glass" style="border-left-color: #10b981;">
                    <h4>ASB Bank</h4>
                    <ul>
                        <li>â€¢ Date, Unique Id, Amount, Payee</li>
                        <li>â€¢ Includes transaction type</li>
                        <li>â€¢ Memo field supported</li>
                    </ul>
                </div>
                
                <div class="format-card glass" style="border-left-color: #8b5cf6;">
                    <h4>BNZ Bank</h4>
                    <ul>
                        <li>â€¢ Date, Amount, Payee, Description</li>
                        <li>â€¢ Reference fields included</li>
                        <li>â€¢ Transaction type classification</li>
                    </ul>
                </div>
                
                <div class="format-card glass" style="border-left-color: #f59e0b;">
                    <h4>Kiwibank</h4>
                    <ul>
                        <li>â€¢ Date, Memo/Description, Amount</li>
                        <li>â€¢ Balance information included</li>
                        <li>â€¢ Simple format structure</li>
                    </ul>
                </div>
                
                <div class="format-card glass" style="border-left-color: #ef4444;">
                    <h4>Westpac</h4>
                    <ul>
                        <li>â€¢ Comprehensive field set</li>
                        <li>â€¢ Particulars, Code, Reference</li>
                        <li>â€¢ Other Party information</li>
                    </ul>
                </div>
                
                <div class="format-card glass" style="border-left-color: #6366f1;">
                    <h4>Generic CSV</h4>
                    <ul>
                        <li>â€¢ Custom mapping available</li>
                        <li>â€¢ Date, Amount, Description minimum</li>
                        <li>â€¢ Auto-detection fallback</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Processing Status -->
        <section class="processing-status glass-premium" id="processingStatus">
            <div class="spinner"></div>
            <h3>Processing Your Bank Statements...</h3>
            <p>Analyzing transactions, detecting duplicates, and categorizing expenses.</p>
        </section>

        <!-- Results Section -->
        <section class="results-section" id="resultsSection">
            <h2 class="section-title" style="margin-bottom: 1rem;">Processing Results</h2>
            
            <div class="results-grid">
                <div class="result-card glass-premium">
                    <div class="result-number positive" id="newTransactions">0</div>
                    <div class="result-label">New Transactions</div>
                </div>
                
                <div class="result-card glass">
                    <div class="result-number" style="color: #f59e0b;" id="duplicatesFound">0</div>
                    <div class="result-label">Duplicates Skipped</div>
                </div>
                
                <div class="result-card glass">
                    <div class="result-number" style="color: #8b5cf6;" id="categorized">0</div>
                    <div class="result-label">Auto-Categorized</div>
                </div>
                
                <div class="result-card glass">
                    <div class="result-number" style="color: #3b82f6;" id="dateRange">-</div>
                    <div class="result-label">Date Range</div>
                </div>
            </div>

            <!-- Transaction Preview -->
            <div class="transaction-preview glass" id="transactionPreview">
                <div class="transaction-header">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 2fr 1fr; gap: 1rem;">
                        <div>Date</div>
                        <div>Amount</div>
                        <div>Description</div>
                        <div>Category</div>
                    </div>
                </div>
                <div id="transactionList">
                    <!-- Transactions will be populated here -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-primary" id="saveData">Save to Dashboard</button>
                <button class="btn btn-secondary" id="exportData">Export Processed Data</button>
                <a href="index.html" class="btn btn-secondary">View Dashboard</a>
            </div>
        </section>
    </main>

    <script src="data-manager.js"></script>
    <script src="notification-system.js"></script>
    <script>
        // Privacy Mode Toggle
        const privacyToggle = document.getElementById('privacyToggle');
        const mainContent = document.getElementById('mainContent');
        
        let privacyMode = localStorage.getItem('privacyMode') === 'true';
        updatePrivacyMode();

        privacyToggle.addEventListener('click', () => {
            privacyMode = !privacyMode;
            localStorage.setItem('privacyMode', privacyMode);
            updatePrivacyMode();
        });

        function updatePrivacyMode() {
            if (privacyMode) {
                mainContent.classList.add('privacy-mode');
                privacyToggle.textContent = 'ðŸ”“ Show Data';
                privacyToggle.classList.add('active');
            } else {
                mainContent.classList.remove('privacy-mode');
                privacyToggle.textContent = 'ðŸ”’ Privacy Mode';
                privacyToggle.classList.remove('active');
            }
        }

        // File Upload Handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const processingStatus = document.getElementById('processingStatus');
        const resultsSection = document.getElementById('resultsSection');

        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // File processing using data manager
        function handleFiles(files) {
            if (files.length === 0) return;

            processingStatus.classList.add('show');
            resultsSection.classList.remove('show');

            // Use FinanceOS Data Manager if available
            if (window.FinanceOSData) {
                window.FinanceOSData.processCSVFiles(files)
                    .then(results => {
                        showResults(results.newTransactions, results.summary.duplicates);
                    })
                    .catch(error => {
                        console.error('CSV processing error:', error);
                        alert('Error processing CSV files. Please check the format and try again.');
                        processingStatus.classList.remove('show');
                    });
            } else {
                // Fallback processing
                setTimeout(() => {
                    processCSVFilesFallback(files);
                }, 2000);
            }
        }

        // Fallback CSV processing if data manager not available
        function processCSVFilesFallback(files) {
            let allTransactions = [];
            let duplicateCount = 0;
            let processedFiles = 0;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    const transactions = parseCSVFallback(content, file.name);
                    
                    // Simple duplicate detection
                    const existingData = JSON.parse(localStorage.getItem('csvData') || '[]');
                    const newTransactions = transactions.filter(t => 
                        !existingData.some(existing => 
                            existing.date === t.date && 
                            existing.amount === t.amount && 
                            existing.description === t.description
                        )
                    );
                    
                    duplicateCount += transactions.length - newTransactions.length;
                    allTransactions = [...allTransactions, ...newTransactions];
                    
                    processedFiles++;
                    if (processedFiles === files.length) {
                        showResults(allTransactions, duplicateCount);
                    }
                };
                reader.readAsText(file);
            });
        }

        function parseCSVFallback(content, filename) {
            const lines = content.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            const transactions = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                if (values.length >= 3) {
                    const transaction = {
                        id: 'txn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        date: values[0] || '',
                        amount: parseFloat(values[1]?.replace(/[^-\d.]/g, '') || '0'),
                        description: values[2] || '',
                        category: 'Uncategorized',
                        sourceFile: filename
                    };
                    transactions.push(transaction);
                }
            }
            
            return transactions;
        }

        function showResults(transactions, duplicateCount) {
            processingStatus.classList.remove('show');
            resultsSection.classList.add('show');
            
            // Update result numbers
            document.getElementById('newTransactions').textContent = transactions.length;
            document.getElementById('duplicatesFound').textContent = duplicateCount;
            document.getElementById('categorized').textContent = transactions.filter(t => t.category !== 'Uncategorized').length;
            
            if (transactions.length > 0) {
                const dates = transactions.map(t => new Date(t.date)).sort();
                const startDate = dates[0].toLocaleDateString();
                const endDate = dates[dates.length - 1].toLocaleDateString();
                document.getElementById('dateRange').textContent = `${startDate} - ${endDate}`;
            }
            
            // Show transaction preview
            displayTransactionPreview(transactions.slice(0, 10));
            
            // Store processed data
            window.processedTransactions = transactions;
        }

        function displayTransactionPreview(transactions) {
            const transactionList = document.getElementById('transactionList');
            transactionList.innerHTML = '';
            
            transactions.forEach(transaction => {
                const row = document.createElement('div');
                row.className = 'transaction-row';
                
                const amountClass = transaction.amount >= 0 ? 'positive' : 'negative';
                const formattedAmount = transaction.amount >= 0 ? 
                    `+$${transaction.amount.toFixed(2)}` : 
                    `-$${Math.abs(transaction.amount).toFixed(2)}`;
                
                row.innerHTML = `
                    <div>${transaction.date}</div>
                    <div class="transaction-amount ${amountClass}">${formattedAmount}</div>
                    <div>${transaction.description}</div>
                    <div>${transaction.category}</div>
                `;
                
                transactionList.appendChild(row);
            });
        }

        // Save data functionality
        document.getElementById('saveData').addEventListener('click', () => {
            if (window.processedTransactions) {
                // Merge with existing data
                const existingData = JSON.parse(localStorage.getItem('csvData') || '[]');
                const mergedData = [...existingData, ...window.processedTransactions];
                
                // Store in localStorage
                localStorage.setItem('csvData', JSON.stringify(mergedData));
                localStorage.setItem('csvUploadDate', new Date().toISOString());
                
                // Trigger CSV upload event for notifications
                if (window.FinanceOSNotifications) {
                    window.dispatchEvent(new CustomEvent('csvUploadSuccess'));
                }
                
                alert('Data saved successfully! You can now view it on the dashboard.');
                
                // Redirect to dashboard
                window.location.href = 'index.html';
            }
        });

        // Export data functionality
        document.getElementById('exportData').addEventListener('click', () => {
            if (window.processedTransactions) {
                const csv = convertToCSV(window.processedTransactions);
                downloadCSV(csv, 'processed-transactions.csv');
            }
        });

        function convertToCSV(data) {
            const headers = ['Date', 'Amount', 'Description', 'Category', 'Source File'];
            const csvContent = [
                headers.join(','),
                ...data.map(t => [
                    t.date,
                    t.amount,
                    `"${t.description}"`,
                    t.category,
                    t.sourceFile || ''
                ].join(','))
            ].join('\n');
            
            return csvContent;
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Notification Settings
        document.getElementById('notificationSettings').addEventListener('click', () => {
            if (window.FinanceOSNotifications) {
                window.FinanceOSNotifications.showNotificationSettings();
            } else {
                alert('Notification system will be available once notifications.js is loaded');
            }
        });

        // Initialize data manager if available
        if (window.FinanceOSHelpers) {
            window.FinanceOSHelpers.initializePage();
        }

        console.log('FinanceOS CSV Upload loaded successfully - No authentication required');
    </script>
</body>
</html>