// ===== ENHANCED DASHBOARD WITH REAL DATA =====
// Add this to your index.html after the existing JavaScript

// Initialize transaction manager
let transactionManager;

// Enhanced dashboard initialization
document.addEventListener('DOMContentLoaded', function() {
    // ... existing initialization code ...
    
    // Initialize transaction manager
    transactionManager = new FinanceOSTransactionManager();
    
    // Update dashboard with real data when logged in
    if (isLoggedIn) {
        setTimeout(function() {
            updateDashboardWithRealData();
        }, 500);
    }
});

// Enhanced login function
function login() {
    console.log('🔑 Logging in...');
    
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('dashboard').classList.add('active');
    document.getElementById('successMsg').classList.add('show');
    
    isLoggedIn = true;
    
    // Save login state with timestamp
    localStorage.setItem('financeOS_loggedIn', 'true');
    localStorage.setItem('financeOS_sessionTime', Date.now().toString());
    
    // Update dashboard with real data
    setTimeout(function() {
        applyPrivacyState();
        updateDashboardWithRealData();
        document.getElementById('successMsg').classList.remove('show');
    }, 1000);
    
    console.log('✅ Logged in successfully with real data');
}

// ===== REAL DATA DASHBOARD UPDATES =====
function updateDashboardWithRealData() {
    console.log('📊 Updating dashboard with real transaction data...');
    
    try {
        // Get real financial data
        const budgetStatus = transactionManager.getBudgetStatus();
        const financialHealth = transactionManager.getFinancialHealth();
        const recentTransactions = transactionManager.getTransactions().slice(0, 10);
        
        // Update financial summary cards
        updateFinancialSummary(budgetStatus, financialHealth);
        
        // Update budget tracking section
        updateBudgetTracking(budgetStatus);
        
        // Update AI insights
        updateAIInsights(financialHealth);
        
        // Update alerts
        updateCriticalAlerts(financialHealth);
        
        console.log('✅ Dashboard updated with real data');
    } catch (error) {
        console.warn('⚠️ Could not update dashboard with real data:', error);
        // Fall back to static data if needed
    }
}

function updateFinancialSummary(budgetStatus, financialHealth) {
    const summary = budgetStatus.summary;
    
    // Update monthly cash flow
    const cashFlowElement = document.querySelector('.summary-card.critical .summary-amount');
    if (cashFlowElement) {
        cashFlowElement.textContent = formatCurrency(-summary.deficit);
        cashFlowElement.className = `summary-amount ${summary.deficit > 0 ? 'negative' : 'positive'} financial-amount medium`;
    }
    
    // Update savings rate info
    const cashFlowChange = document.querySelector('.summary-card.critical .summary-change');
    if (cashFlowChange) {
        const percentage = Math.abs((summary.deficit / summary.monthlyIncome) * 100);
        cashFlowChange.textContent = `${summary.deficit > 0 ? 'Overspending' : 'Saving'} by ${percentage.toFixed(1)}%`;
    }
    
    // Update transaction count info
    const recentCount = transactionManager.getTransactions({
        dateRange: {
            start: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000),
            end: new Date()
        }
    }).length;
    
    // Add transaction count indicator
    addTransactionCounter(recentCount);
}

function updateBudgetTracking(budgetStatus) {
    const budgetGrid = document.querySelector('.budget-grid');
    if (!budgetGrid) return;
    
    // Clear existing budget items
    budgetGrid.innerHTML = '';
    
    // Add updated budget categories
    budgetStatus.categories.forEach(category => {
        const categoryElement = createBudgetCategoryElement(category);
        budgetGrid.appendChild(categoryElement);
    });
}

function createBudgetCategoryElement(category) {
    const div = document.createElement('div');
    div.className = `budget-category ${category.status === 'over' ? 'over-budget' : category.status === 'good' ? 'on-track' : 'budget-category'}`;
    
    const progressWidth = Math.min(category.percentage, 100);
    const statusText = category.status === 'over' ? `${(category.percentage - 100).toFixed(0)}% Over` : 
                      category.status === 'warning' ? 'Near Limit' : 'On Track';
    
    div.innerHTML = `
        <div class="category-header">
            <div class="category-name">${category.name}</div>
            <div class="category-status">${statusText}</div>
        </div>
        <div class="budget-amounts">
            <div class="amount-item">
                <div class="amount-label">Budgeted</div>
                <div class="amount-value financial-amount">${formatCurrency(category.budgeted)}</div>
            </div>
            <div class="amount-item">
                <div class="amount-label">Spent</div>
                <div class="amount-value ${category.status === 'over' ? 'negative' : ''} financial-amount">${formatCurrency(category.spent)}</div>
            </div>
            <div class="amount-item">
                <div class="amount-label">${category.remaining >= 0 ? 'Remaining' : 'Over'}</div>
                <div class="amount-value ${category.remaining >= 0 ? 'neutral' : 'negative'} financial-amount">${formatCurrency(Math.abs(category.remaining))}</div>
            </div>
        </div>
        <div class="progress-bar">
            <div class="progress-fill ${category.status === 'over' ? 'over' : category.status === 'good' ? 'good' : ''}" style="width: ${progressWidth}%"></div>
        </div>
        <div class="progress-text">${category.percentage.toFixed(0)}% used • ${getSpendingAdvice(category)}</div>
    `;
    
    return div;
}

function getSpendingAdvice(category) {
    if (category.status === 'over') {
        return `Cut back by ${formatCurrency(category.spent - category.budgeted)}`;
    } else if (category.status === 'warning') {
        return `${formatCurrency(category.remaining)} left this month`;
    } else {
        return `Well managed`;
    }
}

function updateAIInsights(financialHealth) {
    const insightsContainer = document.querySelector('.ai-insights');
    if (!insightsContainer) return;
    
    // Clear existing insights
    const insightItems = insightsContainer.querySelectorAll('.insight-item');
    insightItems.forEach(item => item.remove());
    
    // Add header back
    const header = insightsContainer.querySelector('.section-header');
    if (!header) {
        const headerElement = document.createElement('div');
        headerElement.className = 'section-header';
        headerElement.innerHTML = '<h3 class="section-title">🤖 AI Financial Insights</h3>';
        insightsContainer.insertBefore(headerElement, insightsContainer.firstChild);
    }
    
    // Add real insights
    const insights = generateRealTimeInsights(financialHealth);
    insights.forEach(insight => {
        const insightElement = createInsightElement(insight);
        insightsContainer.appendChild(insightElement);
    });
}

function generateRealTimeInsights(financialHealth) {
    const insights = [];
    
    // Budget deficit insight
    if (financialHealth.monthlyDeficit > 0) {
        insights.push({
            icon: '🔥',
            title: 'Critical: Budget Deficit Emergency',
            description: `You're overspending by ${formatCurrency(financialHealth.monthlyDeficit)}/month. At this rate, you'll accumulate ${formatCurrency(financialHealth.monthlyDeficit * 12)} in additional debt this year. Take immediate action to reduce expenses.`
        });
    }
    
    // Transaction volume insight
    insights.push({
        icon: '📊',
        title: 'Transaction Analysis',
        description: `Processed ${financialHealth.transactionCount} transactions this month. Your top expense categories are driving overspending. Focus on ${financialHealth.topExpenseCategories[0]?.category || 'food and entertainment'} to make the biggest impact.`
    });
    
    // Recommendations insight
    if (financialHealth.recommendations.length > 0) {
        const topRec = financialHealth.recommendations[0];
        insights.push({
            icon: '🎯',
            title: 'Priority Action Required',
            description: `${topRec.message}. This single change could save you ${formatCurrency(topRec.savings)}/month and significantly improve your financial position.`
        });
    }
    
    // Positive insight if available
    const recentTransactions = transactionManager.getTransactions().slice(0, 50);
    const incomeTransactions = recentTransactions.filter(t => t.amount > 0);
    if (incomeTransactions.length > 0) {
        insights.push({
            icon: '💡',
            title: 'Income Stability Detected',
            description: `Your income appears consistent with ${incomeTransactions.length} deposits detected. Focus on expense reduction rather than income increase for faster results.`
        });
    }
    
    return insights;
}

function createInsightElement(insight) {
    const div = document.createElement('div');
    div.className = 'insight-item';
    div.innerHTML = `
        <div class="insight-icon">${insight.icon}</div>
        <div class="insight-content">
            <div class="insight-title">${insight.title}</div>
            <div class="insight-description">${insight.description}</div>
        </div>
    `;
    return div;
}

function updateCriticalAlerts(financialHealth) {
    const alertBanner = document.querySelector('.critical-alert');
    if (!alertBanner) return;
    
    const alertMessage = alertBanner.querySelector('.alert-message');
    if (alertMessage) {
        if (financialHealth.monthlyDeficit > 0) {
            alertMessage.innerHTML = `
                You're spending ${formatCurrency(financialHealth.monthlyDeficit)} more than you earn monthly. 
                Emergency fund is critically low at <span class="financial-amount">$0.17</span>. 
                <strong>Immediate action required to prevent financial collapse.</strong>
                <a href="goals.html" style="color: #60a5fa; text-decoration: underline; margin-left: 8px;">View AI Recovery Plan →</a>
            `;
        } else {
            alertMessage.innerHTML = `
                Congratulations! You've eliminated your budget deficit. Current surplus: ${formatCurrency(-financialHealth.monthlyDeficit)}/month.
                <strong>Now focus on building your emergency fund.</strong>
                <a href="goals.html" style="color: #60a5fa; text-decoration: underline; margin-left: 8px;">View Next Steps →</a>
            `;
            alertBanner.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%)';
            alertBanner.style.borderColor = 'rgba(16, 185, 129, 0.4)';
        }
    }
}

function addTransactionCounter(recentCount) {
    // Add a small indicator showing recent transaction activity
    const dashboardTitle = document.querySelector('.dashboard-title');
    if (dashboardTitle && !document.querySelector('.transaction-counter')) {
        const counter = document.createElement('div');
        counter.className = 'transaction-counter';
        counter.style.cssText = `
            display: inline-block;
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            margin-left: 16px;
            border: 1px solid rgba(16, 185, 129, 0.3);
        `;
        counter.textContent = `${recentCount} transactions this week`;
        dashboardTitle.appendChild(counter);
    }
}

// ===== UTILITY FUNCTIONS =====
function formatCurrency(amount) {
    return new Intl.NumberFormat('en-NZ', {
        style: 'currency',
        currency: 'NZD'
    }).format(amount);
}

// ===== CSV UPLOAD INTEGRATION =====
// Function to call from CSV upload page
function handleSuccessfulUpload(uploadResult) {
    // Store result for dashboard update
    localStorage.setItem('financeOS_lastUpload', JSON.stringify({
        timestamp: new Date().toISOString(),
        result: uploadResult
    }));
    
    // Show success message
    const message = `
        ✅ Successfully processed ${uploadResult.newTransactions} new transactions!
        📊 Categories: ${uploadResult.summary.categoriesFound}
        💰 Total amount: ${formatCurrency(uploadResult.summary.totalAmount)}
        
        Your dashboard has been updated with real data.
    `;
    
    alert(message);
    
    // Redirect to dashboard
    window.location.href = 'index.html';
}

// ===== ENHANCED SESSION MANAGEMENT =====
function restoreSession() {
    console.log('🔄 Restoring session with data...');
    
    const loginScreen = document.getElementById('loginScreen');
    const dashboard = document.getElementById('dashboard');
    
    if (loginScreen && dashboard) {
        loginScreen.style.display = 'none';
        dashboard.classList.add('active');
        
        // Load real data after session restore
        setTimeout(function() {
            applyPrivacyState();
            updateDashboardWithRealData();
        }, 300);
        
        console.log('✅ Session restored with real data');
    } else {
        console.error('❌ Could not restore session - elements not found');
        logout();
    }
}

console.log('📊 Enhanced Dashboard Integration Ready');
console.log('💡 Dashboard will now show real transaction data when available');
console.log('🔄 Upload CSV files to see your actual financial situation');